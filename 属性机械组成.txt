import tkinter as tk
from tkinter import filedialog, messagebox
import pandas as pd
import chardet
from openpyxl import Workbook
from openpyxl.styles import Font, Alignment, Border, Side
from openpyxl.utils import get_column_letter
from datetime import datetime
import openpyxl  # å‡è®¾ä½ ä¹Ÿä½¿ç”¨openpyxlæ¥å¤„ç†Excelæ–‡ä»¶
import numpy as np  # å¯¼å…¥numpy,å¹¶ä½¿ç”¨npä½œä¸ºåˆ«å
from pypinyin import lazy_pinyin  # å¯¼å…¥æ‹¼éŸ³åº“


def get_pinyin_first_letter(text):
    """è·å–æ–‡æœ¬çš„æ‹¼éŸ³é¦–å­—æ¯ï¼ˆç”¨äºæ’åºï¼‰"""
    pinyin_list = lazy_pinyin(str(text))
    return ''.join(pinyin_list).lower()


def read_csv_safe(filepath):
    with open(filepath, 'rb') as f:
        raw = f.read(10000)
        enc = chardet.detect(raw)['encoding']
        if enc is None:
            enc = 'utf-8'
        if enc.lower() in ['gb2312', 'gbk', 'cp936']:
            enc = 'gbk'
    try:
        return pd.read_csv(filepath, encoding=enc)
    except Exception as e:
        raise ValueError(f"æ— æ³•è¯»å– {filepath}ï¼ˆç¼–ç : {enc}ï¼‰: {e}")


def normalize_dlm_column(df):
    """å°†æ•°æ®æ¡†ä¸­ä»»æ„å¤§å°å†™çš„ 'dlm'ã€'dlmc' æˆ– 'äºŒçº§åœ°ç±»' åˆ—ç»Ÿä¸€é‡å‘½åä¸º 'DLMC'"""
    dlm_col = None
    for col in df.columns:
        col_lower = col.strip().lower()
        if col_lower in ['dlm', 'dlmc'] or col.strip() == 'äºŒçº§åœ°ç±»':
            dlm_col = col
            break
    if dlm_col is None:
        raise ValueError("æœªæ‰¾åˆ°åä¸º 'dlm'ã€'dlmc' æˆ– 'äºŒçº§åœ°ç±»' çš„åˆ—ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰")
    df = df.rename(columns={dlm_col: 'DLMC'})
    return df


def find_column_case_insensitive(df, target_col):
    """åœ¨æ•°æ®æ¡†ä¸­æŸ¥æ‰¾æŒ‡å®šåˆ—åï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰"""
    for col in df.columns:
        if col.strip().lower() == target_col.lower():
            return col
    raise ValueError(f"æœªæ‰¾åˆ°åä¸º '{target_col}' çš„åˆ—ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰")


def process_files(sample_path, area_paths, output_path):
    try:
        # è¯»å–æ ·ç‚¹æ–‡ä»¶ï¼ˆå•ä¸ªï¼‰
        df_sample = read_csv_safe(sample_path)

        # è¯»å–å¹¶åˆå¹¶å¤šä¸ªåˆ¶å›¾æ–‡ä»¶
        df_area_list = []
        for path in area_paths:
            df_temp = read_csv_safe(path)
            if 'é¢ç§¯' not in df_temp.columns:
                raise ValueError(f"åˆ¶å›¾æ–‡ä»¶ {path} ä¸­ç¼ºå°‘ 'é¢ç§¯' åˆ—")
            df_area_list.append(df_temp)

        if not df_area_list:
            raise ValueError("æœªæä¾›æœ‰æ•ˆçš„åˆ¶å›¾ç»Ÿè®¡æ–‡ä»¶")

        df_area = pd.concat(df_area_list, ignore_index=True)

        # æŸ¥æ‰¾æœºæ¢°ç»„æˆåˆ—ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
        sand_col = find_column_case_insensitive(df_sample, 'sand')
        silt_col = find_column_case_insensitive(df_sample, 'silt')
        clay_col = find_column_case_insensitive(df_sample, 'clay')

        sand_col_area = find_column_case_insensitive(df_area, 'sand')
        silt_col_area = find_column_case_insensitive(df_area, 'silt')
        clay_col_area = find_column_case_insensitive(df_area, 'clay')

        # æ ‡å‡†åŒ– DLMC åˆ—ï¼ˆæ”¯æŒ DLMC/äºŒçº§åœ°ç±»ï¼‰
        df_sample = normalize_dlm_column(df_sample)
        df_area = normalize_dlm_column(df_area)

        # æ ‡å‡†åŒ– YL å’Œ TS åˆ—ï¼ˆæ”¯æŒ SSub_JZg/YL å’Œ SGen_JZg/TSï¼‰
        # æ ·ç‚¹æ–‡ä»¶
        if 'YL' in df_sample.columns:
            pass
        elif 'SSub_JZg' in df_sample.columns:
            df_sample = df_sample.rename(columns={'SSub_JZg': 'YL'})
        else:
            raise ValueError("æ ·ç‚¹æ–‡ä»¶ç¼ºå°‘'YL'æˆ–'SSub_JZg'åˆ—")
        
        if 'TS' in df_sample.columns:
            pass
        elif 'SGen_JZg' in df_sample.columns:
            df_sample = df_sample.rename(columns={'SGen_JZg': 'TS'})
        else:
            raise ValueError("æ ·ç‚¹æ–‡ä»¶ç¼ºå°‘'TS'æˆ–'SGen_JZg'åˆ—")
        
        # åˆ¶å›¾æ–‡ä»¶
        if 'YL' in df_area.columns:
            pass
        elif 'SSub_JZg' in df_area.columns:
            df_area = df_area.rename(columns={'SSub_JZg': 'YL'})
        else:
            raise ValueError("åˆ¶å›¾æ–‡ä»¶ç¼ºå°‘'YL'æˆ–'SSub_JZg'åˆ—")
        
        if 'TS' in df_area.columns:
            pass
        elif 'SGen_JZg' in df_area.columns:
            df_area = df_area.rename(columns={'SGen_JZg': 'TS'})
        else:
            raise ValueError("åˆ¶å›¾æ–‡ä»¶ç¼ºå°‘'TS'æˆ–'SGen_JZg'åˆ—")

        # é‡å‘½ååˆ—ä»¥ä¿æŒä¸€è‡´
        df_sample.rename(columns={sand_col: 'sand', silt_col: 'silt', clay_col: 'clay'}, inplace=True)
        df_area.rename(columns={sand_col_area: 'sand', silt_col_area: 'silt', clay_col_area: 'clay'}, inplace=True)

        # è½¬æ¢æ•°æ®ç±»å‹
        df_sample['sand'] = pd.to_numeric(df_sample['sand'], errors='coerce')
        df_sample['silt'] = pd.to_numeric(df_sample['silt'], errors='coerce')
        df_sample['clay'] = pd.to_numeric(df_sample['clay'], errors='coerce')
        df_area['sand'] = pd.to_numeric(df_area['sand'], errors='coerce')
        df_area['silt'] = pd.to_numeric(df_area['silt'], errors='coerce')
        df_area['clay'] = pd.to_numeric(df_area['clay'], errors='coerce')
        df_area['é¢ç§¯'] = pd.to_numeric(df_area['é¢ç§¯'], errors='coerce')

        # ========== ç¬¬ä¸€éƒ¨åˆ†ï¼šæœºæ¢°ç»„æˆç»Ÿè®¡ï¼ˆSheet1ï¼‰==========
        wb = Workbook()
        ws1 = wb.active
        ws1.title = "æœºæ¢°ç»„æˆæ€»ä½“æƒ…å†µ"

        # --- åŸæœ‰æ±‡æ€»è¡¨ ---
        ws1.merge_cells('A1:F1')
        ws1['A1'] = 'åœŸå£¤æœºæ¢°ç»„æˆåˆ†å¸ƒç»Ÿè®¡'
        ws1['A1'].font = Font(bold=True, size=14)
        ws1['A1'].alignment = Alignment(horizontal='center')

        ws1.merge_cells('A2:B2')
        ws1['A2'] = 'ç»„æˆç±»å‹'
        ws1.merge_cells('C2:D2')
        ws1['C2'] = 'æ ·ç‚¹ç»Ÿè®¡%'
        ws1.merge_cells('E2:F2')
        ws1['E2'] = 'åˆ¶å›¾ç»Ÿè®¡%'

        ws1['A3'], ws1['B3'] = 'æˆåˆ†', 'åç§°'
        ws1['C3'], ws1['D3'] = 'å«é‡/%', 'å æ¯”/%'
        ws1['E3'], ws1['F3'] = 'å«é‡/%', 'å æ¯”/%'

        # è¿‡æ»¤æ‰å€¼ä¸º0çš„è¡Œï¼ˆæ ·ç‚¹å’Œåˆ¶å›¾éƒ½è¿‡æ»¤ï¼‰
        df_sample_filtered = df_sample[(df_sample['sand'] + df_sample['silt'] +df_sample['clay']) > 0]
        df_area_filtered = df_area[(df_area['sand'] + df_area['silt'] + df_area['clay']) > 0]

        components = ['ç ‚ç²’', 'ç²‰ç²’', 'é»ç²’']
        sample_values = [
            df_sample_filtered['sand'].mean(),
            df_sample_filtered['silt'].mean(),
            df_sample_filtered['clay'].mean()
        ]
        area_values = [
            df_area_filtered['sand'].mean(),
            df_area_filtered['silt'].mean(),
            df_area_filtered['clay'].mean()
        ]

        for i, comp in enumerate(components):
            row = 4 + i
            ws1.cell(row, 1, comp)
            ws1.cell(row, 2, f'{comp}%')
            ws1.cell(row, 3, round(sample_values[i], 3))
            ws1.cell(row, 4, round(sample_values[i], 3))
            ws1.cell(row, 5, round(area_values[i], 3))
            ws1.cell(row, 6, round(area_values[i], 3))

        total_sample = sum(sample_values)
        total_area = sum(area_values)
        ws1.merge_cells('A7:B7')
        ws1['A7'] = 'æ€»è®¡'
        ws1['C7'] = round(total_sample, 3)
        ws1['D7'] = round(total_sample, 3)
        ws1['E7'] = round(total_area, 3)
        ws1['F7'] = round(total_area, 3)

        # æ ¼å¼åŒ–åŸæœ‰è¡¨æ ¼
        thin = Side(border_style="thin")
        border = Border(top=thin, left=thin, right=thin, bottom=thin)
        for row in ws1.iter_rows(min_row=1, max_row=7, min_col=1, max_col=6):
            for cell in row:
                cell.border = border
                cell.alignment = Alignment(horizontal='center', vertical='center')
        for col in range(1, 7):
            ws1.cell(2, col).font = Font(bold=True)
            ws1.cell(3, col).font = Font(bold=True)
        for r in range(4, 7):
            ws1.cell(r, 1).font = Font(bold=True)
        for col, w in zip(['A', 'B', 'C', 'D', 'E', 'F'], [10, 12, 12, 12, 12, 12]):
            ws1.column_dimensions[col].width = w

        # ==================== æ–°å¢ï¼šåˆ†çº§ç»Ÿè®¡è¡¨ ====================
        def classify_grade(value):
            if pd.isna(value):
                return None
            if value > 65 and value <= 100:
                return "â… çº§"
            elif value > 45:
                return "â…¡çº§"
            elif value > 25:
                return "â…¢çº§"
            elif value > 15:
                return "â…£çº§"
            else:
                return "â…¤çº§"

        grade_ranges = {
            "â… çº§": "65~100",
            "â…¡çº§": "45~65",
            "â…¢çº§": "25~45",
            "â…£çº§": "15~25",
            "â…¤çº§": "â‰¤15"
        }
        grades_order = ["â… çº§", "â…¡çº§", "â…¢çº§", "â…£çº§", "â…¤çº§"]

        # è¿‡æ»¤æ‰å€¼ä¸º0çš„è¡Œï¼ˆæ ·ç‚¹å’Œåˆ¶å›¾éƒ½è¿‡æ»¤ï¼‰
        df_sample_valid = df_sample_filtered[['sand', 'silt', 'clay']].dropna()
        df_area_valid = df_area_filtered[['sand', 'silt', 'clay', 'é¢ç§¯']].dropna(subset=['sand', 'silt', 'clay'])

        # å…¨å±€é¢ç§¯æ€»å’Œï¼ˆç”¨äºå æ¯”ï¼Œè¿‡æ»¤0å€¼ï¼‰
        total_area_sum = df_area_valid['é¢ç§¯'].sum() if 'é¢ç§¯' in df_area_valid.columns else 0

        start_row = 9  # åœ¨åŸè¡¨ä¸‹æ–¹ç©ºä¸€è¡Œå¼€å§‹

        for particle, col_name in [("ç ‚ç²’", "sand"), ("ç²‰ç²’", "silt"), ("é»ç²’", "clay")]:
            # æ·»åŠ æ ‡é¢˜
            ws1.merge_cells(start_row=start_row, start_column=1, end_row=start_row, end_column=6)
            ws1.cell(start_row, 1, f"åœŸå£¤ä¸‰æ™®åˆ†çº§ï¼ˆ{particle}ï¼‰")
            ws1.cell(start_row, 1).font = Font(bold=True, size=12)
            ws1.cell(start_row, 1).alignment = Alignment(horizontal='center')
            start_row += 1

            # è¡¨å¤´
            headers = ["åˆ†çº§", "å€¼åŸŸ/%", "æ•°é‡/ä¸ª", "å æ¯”/%", "é¢ç§¯/äº©", "å æ¯”/%"]
            for j, h in enumerate(headers, 1):
                ws1.cell(start_row, j, h)
                ws1.cell(start_row, j).font = Font(bold=True)
            start_row += 1

            # æ ·ç‚¹åˆ†çº§
            df_sample_valid_particle = df_sample_valid[[col_name]].dropna()
            df_sample_valid_particle['grade'] = df_sample_valid_particle[col_name].apply(classify_grade)

            # åˆ¶å›¾åˆ†çº§ï¼ˆéœ€å…³è”é¢ç§¯ï¼‰
            df_area_valid_particle = df_area_valid[[col_name, 'é¢ç§¯']].dropna(subset=[col_name])
            df_area_valid_particle['grade'] = df_area_valid_particle[col_name].apply(classify_grade)

            total_sample_count = len(df_sample_valid_particle)

            for grade in grades_order:
                # æ ·ç‚¹ç»Ÿè®¡
                count = len(df_sample_valid_particle[df_sample_valid_particle['grade'] == grade])
                pct_sample = count / total_sample_count * 100 if total_sample_count > 0 else 0

                # é¢ç§¯ç»Ÿè®¡
                area_df_grade = df_area_valid_particle[df_area_valid_particle['grade'] == grade]
                area_sum = area_df_grade['é¢ç§¯'].sum() if not area_df_grade.empty else 0
                pct_area = area_sum / total_area_sum * 100 if total_area_sum > 0 else 0

                ws1.cell(start_row, 1, grade)
                ws1.cell(start_row, 2, grade_ranges[grade])
                ws1.cell(start_row, 3, count)
                ws1.cell(start_row, 4, round(pct_sample, 3))
                ws1.cell(start_row, 5, round(area_sum, 3))
                ws1.cell(start_row, 6, round(pct_area, 3))
                start_row += 1

            # å…¨åŒºæ±‡æ€»è¡Œ
            ws1.cell(start_row, 1, "å…¨åŒº")
            ws1.cell(start_row, 2, "")
            ws1.cell(start_row, 3, total_sample_count)
            ws1.cell(start_row, 4, 100.0 if total_sample_count > 0 else 0)
            ws1.cell(start_row, 5, round(total_area_sum, 3))
            ws1.cell(start_row, 6, 100.0 if total_area_sum > 0 else 0)
            start_row += 1

            # å…¨åŒºå‡å€¼ã€ä¸­ä½å€¼ã€èŒƒå›´ï¼ˆæ ·ç‚¹ç»Ÿè®¡ï¼Œæ’é™¤0å€¼ï¼‰
            sample_vals = df_sample_valid_particle[col_name].dropna()
            if len(sample_vals) > 0:
                mean_val_sample = round(sample_vals.mean(), 3)
                median_val_sample = round(sample_vals.median(), 3)
                min_val_sample = round(sample_vals.min(), 3)
                max_val_sample = round(sample_vals.max(), 3)
                range_str_sample = f"{min_val_sample}~{max_val_sample}"
            else:
                mean_val_sample = median_val_sample = range_str_sample = ""

            # å…¨åŒºå‡å€¼ã€ä¸­ä½å€¼ã€èŒƒå›´ï¼ˆé¢ç§¯ç»Ÿè®¡ï¼Œæ’é™¤0å€¼ï¼‰
            area_vals = df_area_valid_particle[col_name].dropna()
            if len(area_vals) > 0:
                mean_val_area = round(area_vals.mean(), 3)
                median_val_area = round(area_vals.median(), 3)
                min_val_area = round(area_vals.min(), 3)
                max_val_area = round(area_vals.max(), 3)
                range_str_area = f"{min_val_area}~{max_val_area}"
            else:
                mean_val_area = median_val_area = range_str_area = ""

            # å†™å…¥ Excel è¡¨æ ¼ï¼ˆæ¯é¡¹ä¸€è¡Œï¼Œæ ·ç‚¹åœ¨ C åˆ—ï¼Œé¢ç§¯åœ¨ E åˆ—ï¼‰
            ws1.cell(start_row, 1, "å…¨åŒºå‡å€¼/%")
            ws1.cell(start_row, 3, mean_val_sample)  # æ ·ç‚¹ç»Ÿè®¡
            ws1.cell(start_row, 5, mean_val_area)  # é¢ç§¯ç»Ÿè®¡
            start_row += 1

            ws1.cell(start_row, 1, "å…¨åŒºä¸­ä½å€¼/%")
            ws1.cell(start_row, 3, median_val_sample)  # æ ·ç‚¹ç»Ÿè®¡
            ws1.cell(start_row, 5, median_val_area)  # é¢ç§¯ç»Ÿè®¡
            start_row += 1

            ws1.cell(start_row, 1, "å…¨åŒºèŒƒå›´/%")
            ws1.cell(start_row, 3, range_str_sample)  # æ ·ç‚¹ç»Ÿè®¡
            ws1.cell(start_row, 5, range_str_area)  # é¢ç§¯ç»Ÿè®¡
            start_row += 2  # ç©ºä¸€è¡Œåˆ†éš”ä¸‹ä¸€ä¸ªç²’çº§
        # æœ€åç»Ÿä¸€è®¾ç½®è¾¹æ¡†å’Œåˆ—å®½ï¼ˆè¦†ç›–æ•´ä¸ªä½¿ç”¨åŒºåŸŸï¼‰
        max_used_row = start_row - 1
        for row in ws1.iter_rows(min_row=1, max_row=max_used_row, min_col=1, max_col=6):
            for cell in row:
                if cell.value is not None or cell.row <= 7:  # é¿å…ç©ºç™½å•å…ƒæ ¼æ— æ„ä¹‰åŠ è¾¹æ¡†
                    cell.border = border
                    cell.alignment = Alignment(horizontal='center', vertical='center')

        for col in ['A', 'B', 'C', 'D', 'E', 'F']:
            ws1.column_dimensions[col].width = 14

        # ========== ç¬¬äºŒéƒ¨åˆ†ï¼šåœŸåœ°åˆ©ç”¨ç±»å‹ç»Ÿè®¡ï¼ˆSheet2ï¼‰==========
        def get_land_class(dlmc):
            if pd.isna(dlmc):
                return None
            s = str(dlmc).strip()
            if s in ["æ°´ç”°", "æ°´æµ‡åœ°", "æ—±åœ°"]:
                return ("è€•åœ°", s)
            elif s in ["æœå›­", "èŒ¶å›­"]:
                return ("å›­åœ°", s)
            elif "å›­åœ°" in s:
                return ("å›­åœ°", "å…¶ä»–å›­åœ°")
            elif "æ—åœ°" in s:
                return ("æ—åœ°", "æ—åœ°")
            elif "è‰åœ°" in s:
                return ("è‰åœ°", "è‰åœ°")
            else:
                return ("å…¶ä»–", "å…¶ä»–")

        df_sample[['ä¸€çº§', 'äºŒçº§']] = df_sample['DLMC'].apply(get_land_class).apply(pd.Series)
        df_area[['ä¸€çº§', 'äºŒçº§']] = df_area['DLMC'].apply(get_land_class).apply(pd.Series)
        df_sample = df_sample.dropna(subset=['ä¸€çº§'])
        df_area = df_area.dropna(subset=['ä¸€çº§'])

        ws2 = wb.create_sheet(title="æœºæ¢°ç»„æˆä¸åŒåœŸåœ°åˆ©ç”¨ç±»å‹")

        # ===== è¡¨å¤´è®¾ç½®ï¼ˆ10åˆ—ï¼‰=====
        ws2.merge_cells('A1:J1')
        ws2['A1'] = 'ä¸åŒåœŸåœ°åˆ©ç”¨ç±»å‹æœºæ¢°ç»„æˆç»Ÿè®¡'
        ws2['A1'].font = Font(bold=True, size=14)
        ws2['A1'].alignment = Alignment(horizontal='center')

        ws2['A2'] = 'ä¸€çº§'
        ws2['B2'] = 'äºŒçº§'
        ws2['C2'] = 'æ ·ç‚¹æ•°'
        ws2['D2'] = 'é¢ç§¯/äº©'
        ws2.merge_cells('E2:G2')  # æ ·ç‚¹ç»Ÿè®¡ è·¨ E2:G2ï¼ˆ3åˆ—ï¼‰
        ws2['E2'] = 'æ ·ç‚¹ç»Ÿè®¡%'
        ws2.merge_cells('H2:J2')  # åˆ¶å›¾ç»Ÿè®¡ è·¨ H2:J2ï¼ˆ3åˆ—ï¼‰
        ws2['H2'] = 'åˆ¶å›¾ç»Ÿè®¡%'

        # æ–°åˆ—é¡ºåºï¼šæ ·ç‚¹æ•°ã€é¢ç§¯/äº© | ç ‚ç²’%ã€ç²‰ç²’%ã€é»ç²’% | ç ‚ç²’%ã€ç²‰ç²’%ã€é»ç²’%
        ws2['E3'] = 'ç ‚ç²’%'
        ws2['F3'] = 'ç²‰ç²’%'
        ws2['G3'] = 'é»ç²’%'
        ws2['H3'] = 'ç ‚ç²’%'
        ws2['I3'] = 'ç²‰ç²’%'
        ws2['J3'] = 'é»ç²’%'

        for col in ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J']:
            ws2[col + '2'].font = Font(bold=True)
            ws2[col + '3'].font = Font(bold=True)

        current_row = 4
        land_config = {
            "è€•åœ°": ["æ°´ç”°", "æ°´æµ‡åœ°", "æ—±åœ°"],
            "å›­åœ°": ["æœå›­", "èŒ¶å›­", "å…¶ä»–å›­åœ°"],
            "æ—åœ°": ["æ—åœ°"],
            "è‰åœ°": ["è‰åœ°"],
            "å…¶ä»–": ["å…¶ä»–"]
        }

        # è¿‡æ»¤æ‰å€¼ä¸º0çš„è¡Œï¼ˆæ ·ç‚¹å’Œåˆ¶å›¾éƒ½è¿‡æ»¤ï¼‰
        df_sample_filtered = df_sample[(df_sample['sand'] + df_sample['silt'] +df_sample['clay']) > 0]
        df_area_filtered = df_area[(df_area['sand'] + df_area['silt'] + df_area['clay']) > 0]

        all_sand_global = df_sample_filtered['sand'].dropna()
        all_silt_global = df_sample_filtered['silt'].dropna()
        all_clay_global = df_sample_filtered['clay'].dropna()
        global_total_count = len(df_sample_filtered)
        global_total_area = df_area_filtered['é¢ç§¯'].sum()

        start_row_map = {}

        for primary, secondaries in land_config.items():
            sample_primary = df_sample_filtered[df_sample_filtered['ä¸€çº§'] == primary]
            area_primary = df_area_filtered[df_area_filtered['ä¸€çº§'] == primary]

            total_count_p = 0
            total_area_p = 0.0
            sand_vals_all = []
            silt_vals_all = []
            clay_vals_all = []

            start_row_map[primary] = current_row

            for idx, sec in enumerate(secondaries):
                if primary in ["æ—åœ°", "è‰åœ°"]:
                    sample_sec = sample_primary
                    area_sec = area_primary
                else:
                    sample_sec = sample_primary[sample_primary['äºŒçº§'] == sec]
                    area_sec = area_primary[area_primary['äºŒçº§'] == sec]

                count = len(sample_sec)
                sand_vals = sample_sec['sand'].dropna() if not sample_sec.empty else pd.Series([], dtype='float64')
                silt_vals = sample_sec['silt'].dropna() if not sample_sec.empty else pd.Series([], dtype='float64')
                clay_vals = sample_sec['clay'].dropna() if not sample_sec.empty else pd.Series([], dtype='float64')

                # æ ·ç‚¹ç»Ÿè®¡
                if count > 0 and not sand_vals.empty:
                    mean_sand_sample = f"{sand_vals.mean():.3f}"
                    mean_silt_sample = f"{silt_vals.mean():.3f}"
                    mean_clay_sample = f"{clay_vals.mean():.3f}"
                else:
                    mean_sand_sample = ""
                    mean_silt_sample = ""
                    mean_clay_sample = ""

                # åˆ¶å›¾ç»Ÿè®¡ï¼ˆä¸åŠ æƒï¼‰
                if not area_sec.empty and 'é¢ç§¯' in area_sec.columns:
                    area_val = area_sec['é¢ç§¯'].sum()
                    sand_area_vals = area_sec['sand'].dropna()
                    silt_area_vals = area_sec['silt'].dropna()
                    clay_area_vals = area_sec['clay'].dropna()

                    if not sand_area_vals.empty:
                        # ä¸åŠ æƒå¹³å‡
                        mean_sand_area = f"{sand_area_vals.mean():.3f}"
                        mean_silt_area = f"{silt_area_vals.mean():.3f}"
                        mean_clay_area = f"{clay_area_vals.mean():.3f}"
                    else:
                        mean_sand_area = ""
                        mean_silt_area = ""
                        mean_clay_area = ""

                else:
                    area_val = 0.0
                    mean_sand_area = ""
                    mean_silt_area = ""
                    mean_clay_area = ""

                # å†™å…¥å•å…ƒæ ¼ï¼ˆæ–°åˆ—é¡ºåºï¼‰
                if idx == 0:
                    ws2.cell(row=current_row, column=1, value=primary)
                else:
                    ws2.cell(row=current_row, column=1, value="")

                ws2.cell(row=current_row, column=2, value=sec)
                ws2.cell(row=current_row, column=3, value=count)  # æ ·ç‚¹æ•°
                ws2.cell(row=current_row, column=4, value=round(area_val, 3))  # é¢ç§¯
                ws2.cell(row=current_row, column=5, value=mean_sand_sample)  # æ ·ç‚¹ç»Ÿè®¡
                ws2.cell(row=current_row, column=6, value=mean_silt_sample)
                ws2.cell(row=current_row, column=7, value=mean_clay_sample)
                ws2.cell(row=current_row, column=8, value=mean_sand_area)  # åˆ¶å›¾ç»Ÿè®¡
                ws2.cell(row=current_row, column=9, value=mean_silt_area)
                ws2.cell(row=current_row, column=10, value=mean_clay_area)

                total_count_p += count
                total_area_p += area_val
                sand_vals_all.extend(sand_vals.tolist())
                silt_vals_all.extend(silt_vals.tolist())
                clay_vals_all.extend(clay_vals.tolist())
                current_row += 1

            # åˆè®¡è¡Œï¼ˆä»…è€•åœ°ã€å›­åœ°ï¼‰
            if primary in ["è€•åœ°", "å›­åœ°"]:
                sand_series = pd.Series(sand_vals_all)
                silt_series = pd.Series(silt_vals_all)
                clay_series = pd.Series(clay_vals_all)

                if len(sand_series) > 0:
                    mean_sand_all = f"{sand_series.mean():.3f}"
                    mean_silt_all = f"{silt_series.mean():.3f}"
                    mean_clay_all = f"{clay_series.mean():.3f}"
                else:
                    mean_sand_all = mean_silt_all = mean_clay_all = ""

                # ä¸åŠ æƒå¹³å‡
                area_primary_filtered = area_primary.dropna(subset=['sand', 'silt', 'clay'])
                if not area_primary_filtered.empty:
                    mean_sand_area_all = f"{area_primary_filtered['sand'].mean():.3f}"
                    mean_silt_area_all = f"{area_primary_filtered['silt'].mean():.3f}"
                    mean_clay_area_all = f"{area_primary_filtered['clay'].mean():.3f}"
                else:
                    mean_sand_area_all = mean_silt_area_all = mean_clay_area_all = ""

                ws2.cell(row=current_row, column=1, value="")
                ws2.cell(row=current_row, column=2, value="åˆè®¡")
                ws2.cell(row=current_row, column=3, value=total_count_p)  # æ ·ç‚¹æ•°
                ws2.cell(row=current_row, column=4, value=round(total_area_p, 3))  # é¢ç§¯
                ws2.cell(row=current_row, column=5, value=mean_sand_all)  # æ ·ç‚¹ç»Ÿè®¡
                ws2.cell(row=current_row, column=6, value=mean_silt_all)
                ws2.cell(row=current_row, column=7, value=mean_clay_all)
                ws2.cell(row=current_row, column=8, value=mean_sand_area_all)  # åˆ¶å›¾ç»Ÿè®¡
                ws2.cell(row=current_row, column=9, value=mean_silt_area_all)
                ws2.cell(row=current_row, column=10, value=mean_clay_area_all)
                current_row += 1

                # åˆå¹¶ä¸€çº§ç±»
                end_row = current_row - 1
                ws2.merge_cells(f'A{start_row_map[primary]}:A{end_row}')
                ws2.cell(row=start_row_map[primary], column=1).alignment = Alignment(horizontal='center', vertical='center')

        # å…¨å¸‚æ€»è®¡
        if len(all_sand_global) > 0:
            global_mean_sand = f"{all_sand_global.mean():.3f}"
            global_mean_silt = f"{all_silt_global.mean():.3f}"
            global_mean_clay = f"{all_clay_global.mean():.3f}"
        else:
            global_mean_sand = global_mean_silt = global_mean_clay = ""

        # å…¨å¸‚ä¸åŠ æƒå¹³å‡
        area_all_filtered = df_area_filtered.dropna(subset=['sand', 'silt', 'clay'])
        if not area_all_filtered.empty:
            global_mean_sand_area = f"{area_all_filtered['sand'].mean():.3f}"
            global_mean_silt_area = f"{area_all_filtered['silt'].mean():.3f}"
            global_mean_clay_area = f"{area_all_filtered['clay'].mean():.3f}"
        else:
            global_mean_sand_area = global_mean_silt_area = global_mean_clay_area = ""

        ws2.cell(row=current_row, column=1, value="å…¨å¸‚")
        ws2.cell(row=current_row, column=2, value="")
        ws2.cell(row=current_row, column=3, value=global_total_count)  # æ ·ç‚¹æ•°
        ws2.cell(row=current_row, column=4, value=round(global_total_area, 3))  # é¢ç§¯
        ws2.cell(row=current_row, column=5, value=global_mean_sand)  # æ ·ç‚¹ç»Ÿè®¡
        ws2.cell(row=current_row, column=6, value=global_mean_silt)
        ws2.cell(row=current_row, column=7, value=global_mean_clay)
        ws2.cell(row=current_row, column=8, value=global_mean_sand_area)  # åˆ¶å›¾ç»Ÿè®¡
        ws2.cell(row=current_row, column=9, value=global_mean_silt_area)
        ws2.cell(row=current_row, column=10, value=global_mean_clay_area)
        # åˆå¹¶â€œå…¨å¸‚â€æ€»åˆè®¡è¡Œçš„Aã€Bä¸¤åˆ—
        ws2.merge_cells(start_row=current_row, start_column=1, end_row=current_row, end_column=2)
        ws2.cell(row=current_row, column=1).alignment = Alignment(horizontal='center', vertical='center')

        # æ ¼å¼åŒ–
        thin = Side(border_style="thin")
        border = Border(top=thin, left=thin, right=thin, bottom=thin)
        for row in ws2.iter_rows(min_row=1, max_row=current_row, min_col=1, max_col=10):
            for cell in row:
                cell.border = border
                cell.alignment = Alignment(horizontal='center', vertical='center')

        for col in ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J']:
            ws2.column_dimensions[col].width = 12

    except Exception as e:
        return False, str(e)

    # ========== ç¬¬ä¸‰éƒ¨åˆ†ï¼šä¹¡é•‡çº§ç»Ÿè®¡ï¼ˆSheet3ï¼‰==========
    ws3 = wb.create_sheet(title="æœºæ¢°ç»„æˆåˆ†ä¹¡é•‡ç»Ÿè®¡")

    # è¡¨å¤´ï¼ˆ8åˆ—ï¼‰
    ws3.merge_cells('A1:A2')
    ws3['A1'] = 'åŒºå¿'
    ws3['A1'].font = Font(bold=True, size=12)
    ws3['A1'].alignment = Alignment(horizontal='center')

    ws3['B2'] = 'æ ·ç‚¹æ•°'
    ws3['C2'] = 'é¢ç§¯/äº©'
    
    ws3.merge_cells('D1:F1')
    ws3['D1'] = 'æ ·ç‚¹ç»Ÿè®¡%'
    ws3.merge_cells('G1:I1')
    ws3['G1'] = 'åˆ¶å›¾ç»Ÿè®¡%'

    ws3['D2'], ws3['E2'], ws3['F2'], ws3['G2'], ws3['H2'], ws3['I2'] = \
        'ç ‚ç²’%', 'ç²‰ç²’%', 'é»ç²’%', 'ç ‚ç²’%', 'ç²‰ç²’%', 'é»ç²’%'

    for col in ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I']:
        ws3[col + '1'].font = Font(bold=True)
        ws3[col + '2'].font = Font(bold=True)

    # è¿‡æ»¤æ‰å€¼ä¸º0çš„è¡Œï¼ˆæ ·ç‚¹å’Œåˆ¶å›¾éƒ½è¿‡æ»¤ï¼‰
    df_sample_filtered = df_sample[(df_sample['sand'] + df_sample['silt'] + df_sample['clay'] )> 0]
    df_area_filtered = df_area[(df_area['sand'] + df_area['silt'] + df_area['clay']) > 0]

    # è·å–æ‰€æœ‰ä¹¡é•‡åç§°ï¼ˆå»é‡ï¼‰å¹¶æŒ‰æ‹¼éŸ³æ’åº
    towns_sample = df_sample_filtered['è¡Œæ”¿åŒºåç§°'].dropna().astype(str).unique()
    towns_area = df_area_filtered['è¡Œæ”¿åŒºåç§°'].dropna().astype(str).unique()
    all_towns = np.union1d(towns_sample, towns_area)  # åˆå¹¶ä¸¤ä¸ªæ•°ç»„çš„å”¯ä¸€å€¼
    all_towns = sorted(all_towns, key=get_pinyin_first_letter)  # æ‹¼éŸ³æ’åº

    current_row = 3

    # === 1. éå†æ‰€æœ‰ä¹¡é•‡ï¼Œå†™å…¥å„è¡Œ ===
    for town in all_towns:
        # æ ·ç‚¹ç»Ÿè®¡
        sample_town = df_sample_filtered[df_sample_filtered['è¡Œæ”¿åŒºåç§°'] == town]
        count = len(sample_town)
        mean_sand_sample = sample_town['sand'].mean() if count > 0 else 0
        mean_silt_sample = sample_town['silt'].mean() if count > 0 else 0
        mean_clay_sample = sample_town['clay'].mean() if count > 0 else 0

        # åˆ¶å›¾ç»Ÿè®¡ï¼ˆä¸åŠ æƒï¼‰
        area_town = df_area_filtered[df_area_filtered['è¡Œæ”¿åŒºåç§°'] == town]
        area_sum = area_town['é¢ç§¯'].sum() if 'é¢ç§¯' in area_town.columns and not area_town.empty else 0

        if not area_town.empty:
            mean_sand_area = area_town['sand'].mean()
            mean_silt_area = area_town['silt'].mean()
            mean_clay_area = area_town['clay'].mean()
        else:
            mean_sand_area = mean_silt_area = mean_clay_area = 0

        # å†™å…¥è¡Œï¼ˆæ–°åˆ—é¡ºåºï¼‰
        ws3.cell(row=current_row, column=1, value=town)
        ws3.cell(row=current_row, column=2, value=count)  # æ ·ç‚¹æ•°
        ws3.cell(row=current_row, column=3, value=round(area_sum, 3))  # é¢ç§¯
        ws3.cell(row=current_row, column=4, value=round(mean_sand_sample, 3))  # æ ·ç‚¹ç»Ÿè®¡
        ws3.cell(row=current_row, column=5, value=round(mean_silt_sample, 3))
        ws3.cell(row=current_row, column=6, value=round(mean_clay_sample, 3))
        ws3.cell(row=current_row, column=7, value=round(mean_sand_area, 3))  # åˆ¶å›¾ç»Ÿè®¡
        ws3.cell(row=current_row, column=8, value=round(mean_silt_area, 3))
        ws3.cell(row=current_row, column=9, value=round(mean_clay_area, 3))
        current_row += 1

    # === 2. å…¨å¸‚æ±‡æ€»ï¼ˆä»…ä¸€æ¬¡ï¼Œæ”¾åœ¨å¾ªç¯å¤–ï¼‰===
    count_all = len(df_sample_filtered)
    mean_sand_sample_all = df_sample_filtered['sand'].mean() if count_all > 0 else 0
    mean_silt_sample_all = df_sample_filtered['silt'].mean() if count_all > 0 else 0
    mean_clay_sample_all = df_sample_filtered['clay'].mean() if count_all > 0 else 0

    area_sum_all = df_area_filtered['é¢ç§¯'].sum() if 'é¢ç§¯' in df_area_filtered.columns else 0
    if not df_area_filtered.empty:
        mean_sand_area_all = df_area_filtered['sand'].mean()
        mean_silt_area_all = df_area_filtered['silt'].mean()
        mean_clay_area_all = df_area_filtered['clay'].mean()
    else:
        mean_sand_area_all = mean_silt_area_all = mean_clay_area_all = 0

    # å†™å…¥"å…¨å¸‚"è¡Œï¼ˆæ–°åˆ—é¡ºåºï¼‰
    ws3.cell(row=current_row, column=1, value="å…¨å¸‚")
    ws3.cell(row=current_row, column=2, value=count_all)  # æ ·ç‚¹æ•°
    ws3.cell(row=current_row, column=3, value=round(area_sum_all, 3))  # é¢ç§¯
    ws3.cell(row=current_row, column=4, value=round(mean_sand_sample_all, 3))  # æ ·ç‚¹ç»Ÿè®¡
    ws3.cell(row=current_row, column=5, value=round(mean_silt_sample_all, 3))
    ws3.cell(row=current_row, column=6, value=round(mean_clay_sample_all, 3))
    ws3.cell(row=current_row, column=7, value=round(mean_sand_area_all, 3))  # åˆ¶å›¾ç»Ÿè®¡
    ws3.cell(row=current_row, column=8, value=round(mean_silt_area_all, 3))
    ws3.cell(row=current_row, column=9, value=round(mean_clay_area_all, 3))
    current_row += 1

    # æ ¼å¼åŒ–è¾¹æ¡†å’Œåˆ—å®½
    thin = Side(border_style="thin")
    border = Border(top=thin, left=thin, right=thin, bottom=thin)
    for row in ws3.iter_rows(min_row=1, max_row=current_row - 1, min_col=1, max_col=9):
        for cell in row:
            cell.border = border
            cell.alignment = Alignment(horizontal='center', vertical='center')

    for col in ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I']:
        ws3.column_dimensions[col].width = 12

    # ========== ç¬¬å››éƒ¨åˆ†ï¼šåœŸå£¤ç±»å‹ç»Ÿè®¡ï¼ˆSheet4ï¼‰==========
    ws4 = wb.create_sheet(title="æœºæ¢°ç»„æˆåˆ†åœŸå£¤ç±»å‹")

    # è¡¨å¤´ï¼ˆ10åˆ—ï¼‰
    ws4.merge_cells('A3:B3')
    ws4['A3'] = 'åœŸå£¤ç±»å‹'
    ws4['A3'].font = Font(bold=True, size=12)
    ws4['A3'].alignment = Alignment(horizontal='center')

    ws4.merge_cells('C3:D3')
    ws4['C3'] = 'å…¶ä»–'
    ws4.merge_cells('E3:G3')
    ws4['E3'] = 'æ ·ç‚¹ç»Ÿè®¡%'
    ws4.merge_cells('H3:J3')
    ws4['H3'] = 'åˆ¶å›¾ç»Ÿè®¡%'

    headers = ['äºšç±»', 'åœŸå±', 'æ ·ç‚¹æ•°', 'é¢ç§¯/äº©', 'ç ‚ç²’%', 'ç²‰ç²’%', 'é»ç²’%', 'ç ‚ç²’%', 'ç²‰ç²’%', 'é»ç²’%']
    for col_idx, header in enumerate(headers, start=1):
        cell = ws4.cell(row=4, column=col_idx, value=header)
        cell.font = Font(bold=True)
        cell.alignment = Alignment(horizontal='center')

    # === æ•°æ®æ¸…æ´— ===
    # è¿‡æ»¤æ‰å€¼ä¸º0çš„è¡Œï¼ˆæ ·ç‚¹å’Œåˆ¶å›¾éƒ½è¿‡æ»¤ï¼‰
    df_sample_clean = df_sample_filtered.dropna(subset=['YL', 'TS']).copy()
    df_area_clean = df_area_filtered.dropna(subset=['YL', 'TS']).copy()

    for df in [df_sample_clean, df_area_clean]:
        df['YL'] = df['YL'].astype(str).str.strip()
        df['TS'] = df['TS'].astype(str).str.strip()

    df_sample_clean['sand'] = pd.to_numeric(df_sample_clean['sand'], errors='coerce')
    df_sample_clean['silt'] = pd.to_numeric(df_sample_clean['silt'], errors='coerce')
    df_sample_clean['clay'] = pd.to_numeric(df_sample_clean['clay'], errors='coerce')

    if 'sand' in df_area_clean.columns:
        df_area_clean['sand'] = pd.to_numeric(df_area_clean['sand'], errors='coerce')
    if 'silt' in df_area_clean.columns:
        df_area_clean['silt'] = pd.to_numeric(df_area_clean['silt'], errors='coerce')
    if 'clay' in df_area_clean.columns:
        df_area_clean['clay'] = pd.to_numeric(df_area_clean['clay'], errors='coerce')
    if 'é¢ç§¯' in df_area_clean.columns:
        df_area_clean['é¢ç§¯'] = pd.to_numeric(df_area_clean['é¢ç§¯'], errors='coerce')

    # è·å–æ‰€æœ‰ (äºšç±», åœŸå±) ç»„åˆ
    all_pairs = pd.concat([
        df_sample_clean[['YL', 'TS']],
        df_area_clean[['YL', 'TS']]
    ]).drop_duplicates().reset_index(drop=True)

    sub_to_gens = {}
    for _, row in all_pairs.iterrows():
        sub, gen = row['YL'], row['TS']
        if sub not in sub_to_gens:
            sub_to_gens[sub] = set()
        sub_to_gens[sub].add(gen)

    # åœŸå£¤ç±»å‹æ’åºæ˜ å°„è¡¨ï¼ˆ39ç§äºšç±» + 200+ç§åœŸå±ï¼‰
    soil_type_order_map = {
            'æ£•çº¢å£¤': ['çº¢æ³¥è´¨æ£•çº¢å£¤'],
            'çº¢å£¤æ€§åœŸ': ['ç ‚æ³¥è´¨çº¢å£¤æ€§åœŸ', 'éº»ç ‚è´¨çº¢å£¤æ€§åœŸ'],
            'å…¸å‹é»„æ£•å£¤': ['æš—æ³¥è´¨é»„æ£•å£¤', 'éº»ç ‚è´¨é»„æ£•å£¤', 'çº¢ç ‚è´¨é»„æ£•å£¤', 'é»„åœŸè´¨é»„æ£•å£¤', 'ç ‚æ³¥è´¨é»„æ£•å£¤'],
            'é»„æ£•å£¤æ€§åœŸ': ['ç ‚æ³¥è´¨é»„æ£•å£¤æ€§åœŸ'],
            'å…¸å‹æ£•å£¤': ['éº»ç ‚è´¨å…¸å‹æ£•å£¤'],
            'ç™½æµ†åŒ–æ£•å£¤': ['éº»ç ‚è´¨ç™½æµ†åŒ–æ£•å£¤', 'æ³¥ç ‚è´¨ç™½æµ†åŒ–æ£•å£¤'],
            'æ½®æ£•å£¤': ['æ³¥ç ‚è´¨æ½®æ£•å£¤'],
            'æ·‹æº¶è¤åœŸ': ['é»„åœŸè´¨æ·‹æº¶è¤åœŸ', 'ç°æ³¥è´¨æ·‹æº¶è¤åœŸ', 'æš—æ³¥è´¨æ·‹æº¶è¤åœŸ'],
            'æ½®è¤åœŸ': ['æ³¥ç ‚è´¨æ½®è¤åœŸ'],
            'çº¢é»åœŸ': ['çº¢é»åœŸ'],
            'é»‘è‰²çŸ³ç°åœŸ': ['é»‘è‰²çŸ³ç°åœŸ'],
            'æ£•è‰²çŸ³ç°åœŸ': ['æ£•è‰²çŸ³ç°åœŸ'],
            'æš—ç«å±±ç°åœŸ': ['æš—ç«å±±ç°åœŸ'],
            'é…¸æ€§ç´«è‰²åœŸ': ['å£¤è´¨é…¸æ€§ç´«è‰²åœŸ', 'é»è´¨é…¸æ€§ç´«è‰²åœŸ'],
            'ä¸­æ€§ç´«è‰²åœŸ': ['ç ‚è´¨ä¸­æ€§ç´«è‰²åœŸ', 'å£¤è´¨ä¸­æ€§ç´«è‰²åœŸ', 'é»è´¨ä¸­æ€§ç´«è‰²åœŸ'],
            'çŸ³ç°æ€§ç´«è‰²åœŸ': ['å£¤è´¨çŸ³ç°æ€§ç´«è‰²åœŸ'],
            'é…¸æ€§ç²—éª¨åœŸ': ['éº»ç ‚è´¨é…¸æ€§ç²—éª¨åœŸ', 'ç¡…è´¨é…¸æ€§ç²—éª¨åœŸ'],
            'ä¸­æ€§ç²—éª¨åœŸ': ['éº»ç ‚è´¨ä¸­æ€§ç²—éª¨åœŸ'],
            'é’™è´¨ç²—éª¨åœŸ': ['ç°æ³¥è´¨é’™è´¨ç²—éª¨åœŸ'],
            'å…¸å‹æ½®åœŸ': ['ç ‚è´¨æ½®åœŸ', 'å£¤è´¨æ½®åœŸ', 'é»è´¨æ½®åœŸ'],
            'ç°æ½®åœŸ': ['ç°æ½®åœŸ', 'çŸ³ç°æ€§ç°æ½®åœŸ'],
            'ç›åŒ–æ½®åœŸï¼ˆå«ç¢±åŒ–æ½®åœŸï¼‰': ['æ°¯åŒ–ç‰©ç›åŒ–æ½®åœŸ', 'ç¡«é…¸ç›ç›åŒ–æ½®åœŸ', 'è‹æ‰“ç›åŒ–æ½®åœŸ'],
            'å…¸å‹ç ‚å§œé»‘åœŸ': ['é»‘è…ç ‚å§œé»‘åœŸï¼ˆé»‘å§œåœŸï¼‰', 'è¦†æ³¥ç ‚å§œé»‘åœŸï¼ˆè¦†æ³¥é»‘å§œåœŸï¼‰'],
            'ç›åŒ–ç ‚å§œé»‘åœŸ': ['æ°¯åŒ–ç‰©ç›åŒ–ç ‚å§œé»‘åœŸ'],
            'è…æ³¥æ²¼æ³½åœŸ': ['è…æ³¥æ²¼æ³½åœŸ'],
            'è‰ç”¸æ²¼æ³½åœŸ': ['è‰ç”¸æ²¼æ³½åœŸ', 'çŸ³ç°æ€§è‰ç”¸æ²¼æ³½åœŸ'],
            'å…¸å‹æ»¨æµ·ç›åœŸ': ['æ°¯åŒ–ç‰©æ»¨æµ·ç›åœŸ'],
            'æ»¨æµ·æ²¼æ³½ç›åœŸ': ['æ°¯åŒ–ç‰©æ²¼æ³½æ»¨æµ·ç›åœŸ'],
            'æ»¨æµ·æ½®æ»©ç›åœŸ': ['æ°¯åŒ–ç‰©æ½®æ»©æ»¨æµ·ç›åœŸ'],
            'æ·¹è‚²æ°´ç¨»åœŸ': ['æµ…é©¬è‚æ³¥ç”°'],
            'æ¸—è‚²æ°´ç¨»åœŸ': ['æ¸—ç°æ³¥ç”°', 'æ¸—æ½®æ³¥ç ‚ç”°', 'æ¸—æ½®æ³¥ç”°', 'æ¸—æ¹–æ³¥ç”°', 'æ¸—æ¶‚æ³¥ç”°', 'æ¸—æ·¡æ¶‚æ³¥ç”°', 'æ¸—éº»ç ‚æ³¥ç”°', 'æ¸—æ½®ç™½åœŸç”°', 'æ¸—é©¬è‚æ³¥ç”°'],
            'æ½´è‚²æ°´ç¨»åœŸ': ['æ½®æ³¥ç”°', 'æ¹–æ³¥ç”°', 'é©¬è‚æ³¥ç”°'],
            'æ½œè‚²æ°´ç¨»åœŸ': ['é’æ¹–æ³¥ç”°', 'é’é©¬è‚æ³¥ç”°'],
            'è„±æ½œæ°´ç¨»åœŸ': ['é»„æ–‘é»ç”°', 'é»„æ–‘æ³¥ç”°'],
            'æ¼‚æ´—æ°´ç¨»åœŸ': ['æ¼‚æ½®ç™½åœŸç”°', 'æ¼‚é©¬è‚æ³¥ç”°'],
            'ç›æ¸æ°´ç¨»åœŸ': ['æ°¯åŒ–ç‰©æ½®æ³¥ç”°', 'æ°¯åŒ–ç‰©æ¶‚æ³¥ç”°', 'æ°¯åŒ–ç‰©æ¹–æ³¥ç”°', 'ç¡«é…¸ç›æ½®æ³¥ç”°', 'ç¡«é…¸ç›æ¶‚æ³¥ç”°', 'è‹æ‰“æ½®æ³¥ç”°', 'è‹æ‰“æ¶‚æ³¥ç”°', 'è‹æ‰“æ¹–æ³¥ç”°'],
            'å¡«å……åœŸ': ['å·¥çŸ¿å¡«å……åœŸ', 'åŸé•‡å¡«å……åœŸ'],
            'æ‰°åŠ¨åœŸ': ['è¿ç§»æ‰°åŠ¨åœŸ']
    }
    
    # ç”Ÿæˆäºšç±»æ’åºåˆ—è¡¨ï¼ˆæŒ‰æ˜ å°„è¡¨é¡ºåºï¼‰
    sub_order = list(soil_type_order_map.keys())
    
    def get_soil_order(soil_name):
        """è·å–åœŸå£¤ç±»å‹çš„æ’åºç´¢å¼•"""
        try:
            return sub_order.index(soil_name)
        except ValueError:
            return len(sub_order)  # æœªåœ¨åˆ—è¡¨ä¸­çš„æ’åˆ°æœ€å
    
    # æŒ‰åœŸå£¤ç±»å‹æ’åºäºšç±»
    sorted_subs = sorted(sub_to_gens.keys(), key=get_soil_order)
    
    # å¯¹æ¯ä¸ªäºšç±»ä¸‹çš„åœŸå±æŒ‰é¢„å®šä¹‰é¡ºåºæ’åº
    for sub in sorted_subs:
        gen_list = list(sub_to_gens[sub])
        if sub in soil_type_order_map:
            # ä½¿ç”¨é¢„å®šä¹‰é¡ºåºæ’åº
            predefined_order = soil_type_order_map[sub]
            def get_gen_order(gen_name):
                try:
                    return predefined_order.index(gen_name)
                except ValueError:
                    return len(predefined_order)  # æœªåœ¨åˆ—è¡¨ä¸­çš„æ’åˆ°æœ€å
            sub_to_gens[sub] = sorted(gen_list, key=get_gen_order)
        else:
            # æ²¡æœ‰é¢„å®šä¹‰é¡ºåºçš„ï¼ŒæŒ‰å­—ç¬¦ä¸²æ’åº
            sub_to_gens[sub] = sorted(gen_list)

    current_row = 5
    a_col_values = []

    for sub in sorted_subs:
        gens = sub_to_gens[sub]
        is_multi = len(gens) > 1

        all_sand_sample = pd.Series([], dtype='float64')
        all_silt_sample = pd.Series([], dtype='float64')
        all_clay_sample = pd.Series([], dtype='float64')
        all_sand_area = pd.Series([], dtype='float64')
        all_silt_area = pd.Series([], dtype='float64')
        all_clay_area = pd.Series([], dtype='float64')
        all_areas = pd.Series([], dtype='float64')

        for gen in gens:
            # --- æ ·ç‚¹ç»Ÿè®¡ ---
            mask_s = (df_sample_clean['YL'] == sub) & (df_sample_clean['TS'] == gen)
            sand_vals = df_sample_clean.loc[mask_s, 'sand'].dropna()
            silt_vals = df_sample_clean.loc[mask_s, 'silt'].dropna()
            clay_vals = df_sample_clean.loc[mask_s, 'clay'].dropna()
            count = len(sand_vals)

            mean_sand_s = f"{sand_vals.mean():.3f}" if count > 0 else ""
            mean_silt_s = f"{silt_vals.mean():.3f}" if count > 0 else ""
            mean_clay_s = f"{clay_vals.mean():.3f}" if count > 0 else ""

            if count > 0:
                all_sand_sample = pd.concat([all_sand_sample, sand_vals.astype('float64')], ignore_index=True)
                all_silt_sample = pd.concat([all_silt_sample, silt_vals.astype('float64')], ignore_index=True)
                all_clay_sample = pd.concat([all_clay_sample, clay_vals.astype('float64')], ignore_index=True)

            # --- åˆ¶å›¾ç»Ÿè®¡ ---
            mask_a = (df_area_clean['YL'] == sub) & (df_area_clean['TS'] == gen)
            area_df = df_area_clean[mask_a]

            area_sum = 0.0
            mean_sand_a = ""
            mean_silt_a = ""
            mean_clay_a = ""
            area_pct = ""

            if not area_df.empty and 'é¢ç§¯' in area_df.columns and 'sand' in area_df.columns:
                area_col = area_df['é¢ç§¯']
                sand_col = area_df['sand']
                silt_col = area_df['silt']
                clay_col = area_df['clay']

                valid_mask = sand_col.notna() & silt_col.notna() & clay_col.notna()
                sand_valid = sand_col[valid_mask]
                silt_valid = silt_col[valid_mask]
                clay_valid = clay_col[valid_mask]

                if len(sand_valid) > 0:
                    area_sum = area_col.sum()
                    # ä¸åŠ æƒå¹³å‡
                    mean_sand_a = f"{sand_valid.mean():.3f}"
                    mean_silt_a = f"{silt_valid.mean():.3f}"
                    mean_clay_a = f"{clay_valid.mean():.3f}"

                    all_sand_area = pd.concat([all_sand_area, sand_valid.astype('float64')], ignore_index=True)
                    all_silt_area = pd.concat([all_silt_area, silt_valid.astype('float64')], ignore_index=True)
                    all_clay_area = pd.concat([all_clay_area, clay_valid.astype('float64')], ignore_index=True)
                    all_areas = pd.concat([all_areas, area_col.astype('float64')], ignore_index=True)

            # å†™å…¥10åˆ—ï¼ˆæ–°åˆ—é¡ºåºï¼‰
            ws4.cell(row=current_row, column=1, value=sub)
            ws4.cell(row=current_row, column=2, value=gen)
            ws4.cell(row=current_row, column=3, value=count)  # æ ·ç‚¹æ•°
            ws4.cell(row=current_row, column=4, value=round(area_sum, 3))  # é¢ç§¯
            ws4.cell(row=current_row, column=5, value=mean_sand_s)  # æ ·ç‚¹ç»Ÿè®¡
            ws4.cell(row=current_row, column=6, value=mean_silt_s)
            ws4.cell(row=current_row, column=7, value=mean_clay_s)
            ws4.cell(row=current_row, column=8, value=mean_sand_a)  # åˆ¶å›¾ç»Ÿè®¡
            ws4.cell(row=current_row, column=9, value=mean_silt_a)
            ws4.cell(row=current_row, column=10, value=mean_clay_a)

            a_col_values.append(sub)
            current_row += 1

        # äºšç±»åˆè®¡è¡Œï¼ˆå¤šåœŸå±æ—¶ï¼‰
        if is_multi:
            count_all = len(all_sand_sample)
            mean_sand_s_all = f"{all_sand_sample.mean():.3f}" if count_all > 0 else ""
            mean_silt_s_all = f"{all_silt_sample.mean():.3f}" if count_all > 0 else ""
            mean_clay_s_all = f"{all_clay_sample.mean():.3f}" if count_all > 0 else ""

            total_area_all = all_areas.sum()
            mean_sand_a_all = ""
            mean_silt_a_all = ""
            mean_clay_a_all = ""

            if len(all_sand_area) > 0:
                # ä¸åŠ æƒå¹³å‡
                mean_sand_a_all = f"{all_sand_area.mean():.3f}"
                mean_silt_a_all = f"{all_silt_area.mean():.3f}"
                mean_clay_a_all = f"{all_clay_area.mean():.3f}"

            ws4.cell(row=current_row, column=1, value="")
            ws4.cell(row=current_row, column=2, value="åˆè®¡")
            ws4.cell(row=current_row, column=3, value=count_all)  # æ ·ç‚¹æ•°
            ws4.cell(row=current_row, column=4, value=round(total_area_all, 3))  # é¢ç§¯
            ws4.cell(row=current_row, column=5, value=mean_sand_s_all)  # æ ·ç‚¹ç»Ÿè®¡
            ws4.cell(row=current_row, column=6, value=mean_silt_s_all)
            ws4.cell(row=current_row, column=7, value=mean_clay_s_all)
            ws4.cell(row=current_row, column=8, value=mean_sand_a_all)  # åˆ¶å›¾ç»Ÿè®¡
            ws4.cell(row=current_row, column=9, value=mean_silt_a_all)
            ws4.cell(row=current_row, column=10, value=mean_clay_a_all)

            a_col_values.append("")
            current_row += 1

    # ========== å…¨å¸‚åˆè®¡ ==========
    count_global = len(df_sample_clean)
    mean_sand_sample_global = f"{df_sample_clean['sand'].mean():.3f}" if count_global > 0 else ""
    mean_silt_sample_global = f"{df_sample_clean['silt'].mean():.3f}" if count_global > 0 else ""
    mean_clay_sample_global = f"{df_sample_clean['clay'].mean():.3f}" if count_global > 0 else ""

    # åˆ¶å›¾å…¨å±€
    global_sand_for_area = df_area_clean['sand'].dropna()
    global_silt_for_area = df_area_clean['silt'].dropna()
    global_clay_for_area = df_area_clean['clay'].dropna()

    total_area_global = df_area_clean['é¢ç§¯'].sum()
    mean_sand_area_global = ""
    mean_silt_area_global = ""
    mean_clay_area_global = ""

    if len(global_sand_for_area) > 0:
        # ä¸åŠ æƒå¹³å‡
        mean_sand_area_global = f"{global_sand_for_area.mean():.3f}"
        mean_silt_area_global = f"{global_silt_for_area.mean():.3f}"
        mean_clay_area_global = f"{global_clay_for_area.mean():.3f}"

    ws4.cell(row=current_row, column=1, value="åˆè®¡")
    ws4.cell(row=current_row, column=2, value="")
    ws4.cell(row=current_row, column=3, value=count_global)  # æ ·ç‚¹æ•°
    ws4.cell(row=current_row, column=4, value=round(total_area_global, 3))  # é¢ç§¯
    ws4.cell(row=current_row, column=5, value=mean_sand_sample_global)  # æ ·ç‚¹ç»Ÿè®¡
    ws4.cell(row=current_row, column=6, value=mean_silt_sample_global)
    ws4.cell(row=current_row, column=7, value=mean_clay_sample_global)
    ws4.cell(row=current_row, column=8, value=mean_sand_area_global)  # åˆ¶å›¾ç»Ÿè®¡
    ws4.cell(row=current_row, column=9, value=mean_silt_area_global)
    ws4.cell(row=current_row, column=10, value=mean_clay_area_global)
    a_col_values.append("åˆè®¡")
    # åˆå¹¶æœ€åæ€»åˆè®¡çš„Aã€Bä¸¤ä¸ªå•å…ƒæ ¼ï¼ˆä»…æœ€åä¸€è¡Œï¼‰
    final_total_row = current_row
    ws4.merge_cells(start_row=final_total_row, start_column=1, end_row=final_total_row, end_column=2)
    ws4.cell(row=final_total_row, column=1).alignment = Alignment(horizontal='center', vertical='center')
    current_row += 1

    # åˆå¹¶ A åˆ—ï¼ˆåŒ…å«æ¯ä¸ªäºšç±»çš„åˆè®¡è¡Œï¼Œä½†ä¸åŒ…å«æœ€åçš„å…¨å¸‚æ€»åˆè®¡ï¼‰
    start_idx = 0
    n = len(a_col_values)
    for i in range(1, n):
        # æ£€æµ‹åˆ°æ–°çš„äºšç±»åç§°æˆ–ç©ºå€¼åé‡åˆ°æ–°äºšç±»ï¼ˆè¯´æ˜å‰ä¸€ä¸ªäºšç±»ç»“æŸï¼‰
        if a_col_values[i] != "" and a_col_values[i] != "åˆè®¡" and a_col_values[i] != a_col_values[start_idx]:
            # å¦‚æœå½“å‰äºšç±»æœ‰å¤šè¡Œï¼ˆåŒ…æ‹¬è¯¥äºšç±»çš„åˆè®¡è¡Œï¼‰ï¼Œåˆ™åˆå¹¶
            if i - start_idx > 1 and a_col_values[start_idx] not in ["", "åˆè®¡"]:
                ws4.merge_cells(
                    start_row=5 + start_idx,
                    start_column=1,
                    end_row=5 + i - 1,
                    end_column=1
                )
                ws4.cell(row=5 + start_idx, column=1).alignment = Alignment(horizontal='center', vertical='center')
            start_idx = i
    
    # å¤„ç†æœ€åä¸€ä¸ªäºšç±»ï¼ˆä½†ä¸åŒ…æ‹¬å…¨å¸‚æ€»åˆè®¡è¡Œï¼‰
    # æ‰¾åˆ°æœ€åä¸€ä¸ª"åˆè®¡"çš„ä½ç½®ï¼ˆå…¨å¸‚æ€»åˆè®¡ï¼‰
    last_total_idx = n - 1
    if a_col_values[last_total_idx] == "åˆè®¡":
        # å¦‚æœæœ€åä¸€ä¸ªäºšç±»æœ‰å¤šè¡Œï¼ˆåŒ…æ‹¬è¯¥äºšç±»çš„åˆè®¡è¡Œï¼‰ï¼Œåˆ™åˆå¹¶
        if last_total_idx - start_idx > 1 and a_col_values[start_idx] not in ["", "åˆè®¡"]:
            ws4.merge_cells(
                start_row=5 + start_idx,
                start_column=1,
                end_row=5 + last_total_idx - 1,
                end_column=1
            )
            ws4.cell(row=5 + start_idx, column=1).alignment = Alignment(horizontal='center', vertical='center')

    # æ ¼å¼åŒ–
    thin = Side(border_style="thin")
    border = Border(top=thin, left=thin, right=thin, bottom=thin)
    for row in ws4.iter_rows(min_row=4, max_row=current_row - 1, min_col=1, max_col=10):
        for cell in row:
            cell.border = border
            cell.alignment = Alignment(horizontal='center', vertical='center')

    for col_letter in ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J']:
        ws4.column_dimensions[col_letter].width = 12

    wb.save(output_path)
    return True, "å¤„ç†æˆåŠŸ"


# =============== GUI ç•Œé¢ ===============
class App:
    def __init__(self, root):
        self.root = root
        self.root.title("åœŸå£¤æœºæ¢°ç»„æˆç»Ÿè®¡åˆ†æ")
        self.root.geometry("580x320")
        self.sample_file = None
        self.area_files = None  # æ”¹ä¸ºåˆ—è¡¨

        tk.Label(root, text="åœŸå£¤æœºæ¢°ç»„æˆåˆ†å¸ƒç»Ÿè®¡", font=("Arial", 12, "bold")).pack(pady=8)
        tk.Label(root, text="â€¢ æ ·ç‚¹æ–‡ä»¶ï¼š1ä¸ª\nâ€¢ åˆ¶å›¾æ–‡ä»¶ï¼šå¯å¤šé€‰ï¼ˆæŒ‰ä½ Ctrl æˆ– Shiftï¼‰", fg="gray").pack()

        tk.Button(root, text="ğŸ“ é€‰æ‹©ã€æ ·ç‚¹ç»Ÿè®¡.csvã€‘", command=self.select_sample).pack(pady=6)
        self.label_sample = tk.Label(root, text="æœªé€‰æ‹©", fg="gray")
        self.label_sample.pack()

        tk.Button(root, text="ğŸ“ é€‰æ‹©ã€åˆ¶å›¾ç»Ÿè®¡.csvã€‘ï¼ˆå¯å¤šé€‰ï¼‰", command=self.select_area).pack(pady=6)
        self.label_area = tk.Label(root, text="æœªé€‰æ‹©", fg="gray")
        self.label_area.pack()

        tk.Button(root, text="âœ… ç”Ÿæˆç»Ÿè®¡è¡¨", command=self.run_process, bg="#4CAF50", fg="white",
                  font=("Arial", 12)).pack(pady=15)

    def select_sample(self):
        f = filedialog.askopenfilename(filetypes=[("CSV files", "*.csv")])
        if f:
            self.sample_file = f
            self.label_sample.config(text=f.split("/")[-1], fg="black")

    def select_area(self):
        files = filedialog.askopenfilenames(filetypes=[("CSV files", "*.csv")])
        if files:
            self.area_files = list(files)
            count = len(files)
            if count == 1:
                self.label_area.config(text=files[0].split("/")[-1], fg="black")
            else:
                self.label_area.config(text=f"å·²é€‰æ‹© {count} ä¸ªåˆ¶å›¾æ–‡ä»¶", fg="black")
        else:
            self.area_files = None
            self.label_area.config(text="æœªé€‰æ‹©", fg="gray")

    def run_process(self):
        if not self.sample_file or not self.area_files:
            messagebox.showwarning("âš ï¸ æç¤º", "è¯·å…ˆé€‰æ‹©æ ·ç‚¹æ–‡ä»¶å’Œè‡³å°‘ä¸€ä¸ªåˆ¶å›¾æ–‡ä»¶ï¼")
            return

        timestamp = datetime.now().strftime("%Y-%m-%d_%H-%M-%S")
        output = f"åœŸå£¤æœºæ¢°ç»„æˆåˆ†å¸ƒç»Ÿè®¡_{timestamp}.xlsx"

        success, msg = process_files(self.sample_file, self.area_files, output)
        if success:
            messagebox.showinfo("ğŸ‰ æˆåŠŸ", f"æ–‡ä»¶å·²ç”Ÿæˆï¼š\n{output}")
        else:
            messagebox.showerror("âŒ é”™è¯¯", f"å¤„ç†å¤±è´¥ï¼š\n{msg}")

if __name__ == "__main__":
    root = tk.Tk()
    app = App(root)
    root.mainloop()



