# 报告生成逻辑优化 - 修改记录

## 修改日期
2025-12-07

## 修改背景
用户反馈报告生成逻辑存在问题：
1. 原逻辑直接从源数据（CSV）读取数据进行分析，导致土地利用类型等信息缺失
2. 正确做法应该调用属性图数据处理的Excel结果文件进行分析
3. 用户要求直接将Excel表格插入Word，不需要重新格式化
4. 用户要求不需要饼图和柱状图，只需要表格

## 修改内容

### 1. 新增文件：`backend/app/topics/attribute_map/excel_reader.py`
Excel结果文件读取器，从属性图数据处理生成的Excel文件中读取统计数据。

**主要类和函数：**

```python
@dataclass
class ExcelAttributeStats:
    """从Excel读取的属性统计数据"""
    attr_key: str
    attr_name: str
    unit: str
    # 总体统计
    sample_total: int
    sample_mean: float
    sample_median: float
    sample_min: float
    sample_max: float
    area_total: float
    area_mean: float
    area_median: float
    area_min: float
    area_max: float
    # 等级统计
    grade_sample_counts: dict[str, int]
    grade_area_sums: dict[str, float]
    # 各类统计DataFrame
    land_use_stats: pd.DataFrame
    town_stats: pd.DataFrame
    soil_type_stats: pd.DataFrame

def read_excel_stats(excel_path, attr_name) -> ExcelAttributeStats | None:
    """从Excel文件读取指定属性的统计数据"""

def read_excel_sheet_as_table(excel_path, sheet_name) -> list[list[str]]:
    """读取Excel sheet的原始表格数据（用于直接插入Word）"""

def get_available_attributes_from_excel(excel_path) -> list[str]:
    """从Excel文件获取可用的属性列表"""
```

**Sheet名称映射（与writers.py生成的名称对应）：**
- 总体情况：`{attr_name}总体情况`
- 土地利用类型：`{attr_name}不同土地利用类型`
- 乡镇统计：`{attr_name}乡镇统计`
- 土壤类型：`{attr_name}分土壤类型`

### 2. 修改文件：`backend/app/topics/attribute_map/generate.py`

**新增函数：**

```python
def _insert_excel_table(doc: Document, table_data: list[list[str]]) -> None:
    """将Excel表格数据直接插入Word文档"""

def generate_report_from_excel(excel_path, attr_name, config, output_path) -> bytes:
    """基于Excel结果文件生成单个属性的分析报告（只有表格，无图表）"""

def generate_multi_report_from_excel(excel_path, attr_names, config, output_path) -> bytes:
    """基于Excel结果文件生成多属性综合分析报告（只有表格，无图表）"""

def _add_attribute_section_from_excel_simple(doc, excel_path, stats, config, section_num) -> None:
    """添加单个属性分析章节（从Excel数据，只包含表格无图表）"""

# 描述生成函数
def _add_overall_description(doc, stats, config) -> None:
    """添加总体情况描述文字"""

def _add_land_use_description(doc, stats, config) -> None:
    """添加土地利用类型描述文字"""

def _add_soil_type_description(doc, stats, config) -> None:
    """添加土壤类型描述文字"""

def _add_town_description(doc, stats, config) -> None:
    """添加乡镇描述文字"""
```

### 3. 修改文件：`backend/app/api/report.py`

**修改内容：**
- `_add_process_record()` 函数增加保存 `excel_path`
- `generate_report_from_process()` 函数完全重写，使用Excel结果文件生成报告

## 报告生成流程

```
用户上传文件 → 属性图数据处理 → 生成Excel结果文件 → 从Excel生成Word报告
                                    ↑                      ↑
                                保存excel_path         读取Excel表格
                                到处理记录              直接插入Word
```

## 报告结构

### 单属性报告 (`generate_report_from_excel`)
```
一、总体情况
  - 样点分析描述（文字段落）
  - 制图分析描述（文字段落）
  - [AI溯源分析]（可选）
  1.1 总体情况统计表（直接复制Excel表格）

二、土地利用类型分析
  - 分析描述（文字段落）
  - [AI分析]（可选）
  2.1 土地利用类型统计表（直接复制Excel表格）

三、土壤类型分析
  - 分析描述（文字段落）
  - [AI分析]（可选）
  3.1 土壤类型统计表（直接复制Excel表格）

四、乡镇分析
  - 分析描述（文字段落）
  - [AI分析]（可选）
  4.1 乡镇统计表（直接复制Excel表格）

生成时间: YYYY-MM-DD HH:MM
```

### 多属性综合报告 (`generate_multi_report_from_excel`)
```
一、报告概述
  - 基本信息描述

二、{属性1}分析
  2.1 总体情况
    - 描述 + 表格
  2.2 土地利用类型分析
    - 描述 + 表格
  2.3 土壤类型分析
    - 描述 + 表格
  2.4 乡镇分析
    - 描述 + 表格

三、{属性2}分析
  ... (同上结构)

生成时间: YYYY-MM-DD HH:MM
```

## 技术要点

1. **Excel读取**：使用openpyxl的`data_only=True`模式，读取计算后的值
2. **表格插入**：使用"Table Grid"样式，居中对齐
3. **描述生成**：从Excel统计数据生成连续文字段落
4. **AI分析**：保留可选的AI分析功能，但不影响主要功能

## 待完成/后续优化

1. 前端可能需要更新UI以适配新的报告生成流程
2. 可以考虑添加表格样式自定义选项
3. 可以考虑添加报告模板功能

## 相关文件

- `backend/app/topics/attribute_map/excel_reader.py` - 新增
- `backend/app/topics/attribute_map/generate.py` - 修改
- `backend/app/topics/attribute_map/writers.py` - 参考（Sheet名称）
- `backend/app/api/report.py` - 修改
