# 农业土壤普查报告生成系统 - 开发阶段计划

## 阶段总览

| 阶段 | 名称 | 目标 | 状态 |
|------|------|------|------|
| P1 | 项目骨架 + 基础框架 | 可运行的空壳 | ✅ 已完成 |
| P2 | 属性图专题 - 数据处理 | 统计计算功能 | ✅ 已完成 |
| P3 | 属性图专题 - 图表生成 | 图表输出 | ✅ 已完成 |
| P4 | 属性图专题 - 报告生成 | 完整报告 | ✅ 已完成 |
| P5 | 打包测试 | exe 文件 | ✅ 已完成 |
| P6+ | 其他专题迭代 | 完整系统 | ⏳ 待开始 |

---

## P1 阶段：项目骨架 + 基础框架 ✅

### 目标
搭建可运行的项目骨架，前后端能正常通信。

### 完成状态：已完成

### 完成情况

#### 后端实现
- [x] 后端目录结构创建完成
- [x] FastAPI 框架配置完成（main.py, config.py）
- [x] API 端点实现（health, topics, config, upload, report, region）
- [x] 数据模型定义（schemas.py）
- [x] 专题基类定义（topics/base.py）
- [x] SQLite 数据库集成（aiosqlite）
- [x] 地区管理 CRUD API

#### 前端实现
- [x] Vue 3 + Vite 项目初始化
- [x] Element Plus + Pinia + Vue Router 配置
- [x] 基础页面实现（Home, Upload, Config, Report）
- [x] 层级选择界面（大类 → 专题 → 地区 → 操作）
- [x] 省市县三级选择功能（河南/安徽/江苏/浙江）
- [x] 跨页面状态保持（Pinia store）
- [x] 页面返回逻辑修复

#### 集成与配置
- [x] 前后端联调配置（Vite proxy, CORS）
- [x] 启动脚本创建（main.py）
- [x] 代码质量检查通过（ruff）

---

## P2 阶段：属性图专题 - 数据处理 ✅

### 目标
实现数据加载和统计计算功能。

### 完成状态：已完成

### 完成情况

#### 核心数据处理模块
- [x] `core/data/__init__.py`: CSV/Excel 文件加载
  - 自动识别编码（GBK/UTF-8）
  - 支持 .csv/.xlsx/.xls 格式
  - 返回 pandas DataFrame

#### 属性图数据处理
- [x] `topics/attribute_map/config.py`: 土壤属性配置
  - 9种土壤属性定义（有机质、全氮、有效磷、速效钾、pH等）
  - 分级标准配置
  - 颜色方案配置

- [x] `topics/attribute_map/stats.py`: 统计计算
  - AttributeStats 数据类
  - 样点统计（均值、中位值、范围）
  - 制图面积统计
  - 等级分布计算
  - 土壤类型分析
  - 乡镇分析

- [x] `topics/attribute_map/process.py`: 数据处理流程
  - 样点数据处理
  - 制图数据处理
  - 综合统计计算

#### API 实现
- [x] `api/upload.py`: 文件上传接口
  - 单文件/多文件上传
  - 数据预览
  - 已上传文件列表

- [x] `api/report.py`: 数据处理接口
  - POST `/api/report/attribute-data`: 属性图数据处理
  - POST `/api/report/mapping-data`: 上图数据处理
  - 处理记录管理

---

## P3 阶段：属性图专题 - 图表生成 ✅

### 目标
实现统计图表的自动生成。

### 完成状态：已完成

### 完成情况

#### 图表模块
- [x] `core/chart/__init__.py`: 图表生成核心
  - 中文字体自动配置
  - 主题支持（professional/modern/classic/nature）
  - 图表缓存机制

- [x] 饼图生成 (`make_grade_pie_chart`)
  - 等级分布饼图
  - 百分比显示
  - 自定义颜色

- [x] 柱状图生成 (`make_grade_bar_chart`)
  - 等级面积柱状图
  - 数值标签

- [x] 乡镇对比图 (`make_town_comparison_chart`)
  - 均值对比柱状图

- [x] 堆叠图生成 (`make_town_grade_stack_chart`)
  - 乡镇等级分布堆叠图

---

## P4 阶段：属性图专题 - 报告生成 ✅

### 目标
实现 Word 报告的自动生成。

### 完成状态：已完成

### 完成情况

#### Word 生成模块
- [x] `topics/attribute_map/generate.py`: 报告生成
  - 单属性报告生成
  - 多属性综合报告生成
  - 报告结构：总体情况 → 土地利用类型 → 土壤类型 → 乡镇分析

- [x] `topics/attribute_map/writers.py`: Excel 结果输出
  - 统计结果写入 Excel
  - 多 Sheet 输出

- [x] `topics/attribute_map/excel_reader.py`: Excel 结果读取 ⭐ 新增
  - 从处理结果 Excel 读取数据
  - 直接插入表格到 Word

#### AI 分析模块
- [x] `core/ai/__init__.py`: AI 文案生成
  - 支持通义千问（Qwen）
  - 支持 DeepSeek
  - 溯源分析、土地利用分析、土壤类型分析、乡镇分析

#### 报告 API
- [x] `api/report.py`: 报告生成接口
  - POST `/api/report/generate-from-process`: 从处理结果生成报告
  - GET `/api/report/download/{filename}`: 报告下载
  - 处理记录列表

#### 前端实现
- [x] Report.vue: 报告页面
  - 处理记录选择
  - 属性选择
  - 报告模式选择（单属性/多属性/全部）
  - AI 分析开关
  - 报告下载

### 最新优化（2025-12-07）

#### 报告生成逻辑重构
- [x] 从 Excel 结果文件读取数据（而非原始 CSV）
- [x] 直接复制 Excel 表格到 Word（保持原格式）
- [x] 移除饼图和柱状图，只保留表格
- [x] 优化文字描述生成

详见：`docs/修改记录_报告生成逻辑优化.md`

### 修复更新（2025-12-08）

#### 等级顺序修复
- [x] 修复报告输出与表格数据不对应的问题
- [x] 统一使用 `get_grade_order()` 获取罗马数字等级顺序
- [x] 修复 `generate.py` 中 5 处等级提取方式
- [x] 修复 `excel_reader.py` 中等级读取方式
- [x] 修复 `report.py` 中 3 处等级提取方式

#### AI 配置管理功能
- [x] 新增 `api/ai_config.py` - AI 配置 CRUD API
- [x] 支持多个 AI 提供商（DeepSeek、通义千问、OpenAI、自定义）
- [x] 前端右上角设置入口
- [x] 配置测试功能
- [x] 设为默认配置功能

#### 文件管理增强
- [x] 上传文件保留原始文件名+时间戳
- [x] 已上传文件列表管理
- [x] 批量删除功能
- [x] 上传文件大小限制提升到 1GB

---

## P5 阶段：打包测试 ✅

### 目标
将应用打包为独立可执行文件。

### 完成状态：已完成

### 已完成任务（2025-12-08）

#### 打包配置
- [x] `build.spec` - PyInstaller 打包规范
  - 前端静态文件嵌入 (`frontend/dist`)
  - 后端模板文件嵌入
  - 隐藏导入配置（FastAPI/Pydantic/Pandas/AI客户端等）
  - 排除不需要的模块（tkinter/PyQt5/PySide等）
  - 修复 `python_dotenv` 引用错误

#### 启动入口优化
- [x] `main.py` - 统一启动入口
  - 支持打包模式（`sys.frozen` 检测）
  - 支持开发模式
  - 自动打开浏览器
  - 依赖检查与安装

#### 配置系统优化
- [x] `backend/app/config.py` - 动态路径配置
  - `get_base_dir()` 支持多环境
  - 环境变量覆盖支持（`SOIL_REPORT_BASE_DIR`）
  - 自动创建必要目录

#### 静态文件服务
- [x] `backend/app/main.py` - 静态文件挂载
  - `get_frontend_dist_path()` 自动查找前端
  - 支持打包模式和开发模式
  - SPA 路由支持（`html=True`）

#### 打包脚本
- [x] `打包程序.bat` - 一键打包脚本
  - 自动构建前端
  - 自动安装 PyInstaller
  - 调用打包命令

#### 打包测试
- [x] 单文件打包测试通过
  - 输出文件：`dist/土壤普查报告系统.exe`
  - 文件大小：约 337MB
  - 包含所有依赖（numpy/pandas/scipy/matplotlib/PyQt6等）

### 待验证任务

- [ ] 在无 Python 环境的 Windows 机器上测试运行
- [ ] 托盘图标（可选增强）

### 验收标准

1. exe 文件可在无 Python 环境的 Windows 上运行
2. 所有功能正常
3. 启动时间 < 10 秒

---

## P6+ 阶段：其他专题迭代 ⏳

### 目标
扩展其他专题类型。

### 待添加专题

- [ ] 类型图专题
- [ ] 土壤适宜性专题
- [ ] 耕地质量专题
- [ ] 其他专题...

### 每个专题需要

1. `topics/{topic_name}/config.py`
2. `topics/{topic_name}/process.py`
3. `topics/{topic_name}/generate.py`
4. 对应的 Word 模板
5. 单元测试

---

## 当前项目文件结构

```
TRPC/
├── main.py                          # 启动入口
├── CLAUDE.md                        # Claude 开发规范
├── backend/
│   ├── app/
│   │   ├── __init__.py
│   │   ├── main.py                  # FastAPI 入口
│   │   ├── config.py                # 全局配置
│   │   ├── models/
│   │   │   ├── __init__.py
│   │   │   └── schemas.py
│   │   ├── api/
│   │   │   ├── __init__.py
│   │   │   ├── upload.py            # 上传 API
│   │   │   ├── config.py            # 配置 API
│   │   │   ├── report.py            # 报告 API ⭐
│   │   │   └── region.py            # 地区管理 API
│   │   ├── core/
│   │   │   ├── __init__.py
│   │   │   ├── database.py          # SQLite 数据库
│   │   │   ├── data/__init__.py     # 数据加载
│   │   │   ├── chart/__init__.py    # 图表生成
│   │   │   ├── word/__init__.py     # Word 生成
│   │   │   └── ai/__init__.py       # AI 分析
│   │   └── topics/
│   │       ├── __init__.py
│   │       ├── base.py
│   │       └── attribute_map/       # 属性图专题 ⭐
│   │           ├── __init__.py
│   │           ├── config.py        # 属性配置
│   │           ├── stats.py         # 统计计算
│   │           ├── process.py       # 数据处理
│   │           ├── generate.py      # 报告生成 ⭐
│   │           ├── writers.py       # Excel 输出
│   │           └── excel_reader.py  # Excel 读取 ⭐ 新增
│   ├── data/                        # SQLite 数据库
│   ├── uploads/                     # 上传文件
│   ├── output/                      # 输出文件
│   └── requirements.txt
├── frontend/
│   ├── src/
│   │   ├── App.vue
│   │   ├── main.js
│   │   ├── views/
│   │   │   ├── Home.vue
│   │   │   ├── Upload.vue
│   │   │   ├── Config.vue
│   │   │   └── Report.vue           # ⭐
│   │   ├── api/
│   │   │   └── index.js
│   │   └── stores/
│   │       └── project.js
│   ├── package.json
│   └── vite.config.js
└── docs/
    ├── 技术路线.md
    ├── 开发阶段计划.md              # 本文件
    └── 修改记录_报告生成逻辑优化.md  # ⭐ 新增
```

---

## 开发规范提醒

### 每次开发前

1. 理解需求和现有代码
2. 制定计划并确认
3. 遵循 CLAUDE.md 代码规范

### 每次提交前

```bash
# 后端检查
cd backend
ruff check .
ruff format .
pytest

# 前端检查
cd frontend
npm run lint
npm run format:check
npm test
```

### 质量红线

- 绝不使用 any 类型
- 绝不跳过错误处理
- 绝不硬编码密钥
- 所有功能必须有测试

---

## 修改历史

| 日期 | 修改内容 |
|------|----------|
| 2025-12-08 | P5 阶段打包测试完成，生成 exe 文件（337MB） |
| 2025-12-08 | P4 修复：等级顺序问题、AI 配置管理功能、文件管理增强 |
| 2025-12-07 | 更新 P2-P4 为已完成，新增报告生成逻辑优化记录 |
| - | P1 阶段完成记录 |
