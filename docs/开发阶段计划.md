# 农业土壤普查报告生成系统 - 开发阶段计划

## 阶段总览

| 阶段 | 名称 | 目标 | 状态 |
|------|------|------|------|
| P1 | 项目骨架 + 基础框架 | 可运行的空壳 | [已完成] |
| P2 | 属性图专题 - 数据处理 | 统计计算功能 | [待开始] |
| P3 | 属性图专题 - 图表生成 | 图表输出 | [待开始] |
| P4 | 属性图专题 - 报告生成 | 完整报告 | [待开始] |
| P5 | 打包测试 | exe 文件 | [待开始] |
| P6+ | 其他专题迭代 | 完整系统 | [待开始] |

---

## P1 阶段：项目骨架 + 基础框架

### 目标
搭建可运行的项目骨架，前后端能正常通信。

### 任务清单

### 完成情况

- [x] 后端目录结构创建完成
- [x] FastAPI 框架配置完成（main.py, config.py）
- [x] API 端点实现（health, topics, config, upload, report）
- [x] 数据模型定义（schemas.py）
- [x] 专题基类定义（topics/base.py）
- [x] 前端 Vue 3 + Vite 项目初始化
- [x] Element Plus + Pinia + Vue Router 配置
- [x] 基础页面实现（Home, Upload, Config, Report）
- [x] 前后端联调配置（Vite proxy, CORS）
- [x] 启动脚本创建（main.py）
- [x] 代码质量检查通过（ruff, pytest）

### 任务清单（参考）

#### 后端 (Backend)

- [x] 创建目录结构
  ```
  backend/
  ├── app/
  │   ├── __init__.py
  │   ├── main.py              # FastAPI 入口
  │   ├── config.py            # 全局配置
  │   ├── api/                  # API 路由
  │   │   ├── __init__.py
  │   │   ├── upload.py
  │   │   ├── config.py
  │   │   └── report.py
  │   ├── core/                 # 核心功能（空模块）
  │   │   ├── __init__.py
  │   │   ├── data/__init__.py
  │   │   ├── chart/__init__.py
  │   │   └── word/__init__.py
  │   ├── topics/               # 专题模块（空模块）
  │   │   ├── __init__.py
  │   │   └── base.py
  │   └── models/               # 数据模型
  │       ├── __init__.py
  │       └── schemas.py
  ├── templates/                # Word 模板目录
  ├── output/                   # 输出目录
  ├── tests/                    # 测试目录
  │   └── __init__.py
  └── requirements.txt
  ```

- [ ] 配置 FastAPI 基础框架
  - main.py: 应用入口、CORS、静态文件挂载
  - config.py: 全局配置（路径、常量）

- [ ] 实现基础 API 端点
  - GET `/api/health`: 健康检查
  - GET `/api/topics`: 返回空列表

- [ ] 配置依赖
  - requirements.txt
  - pyproject.toml（可选）

#### 前端 (Frontend)

- [ ] 初始化 Vue 3 + Vite 项目
  ```
  frontend/
  ├── src/
  │   ├── App.vue
  │   ├── main.js
  │   ├── views/
  │   │   ├── Home.vue
  │   │   ├── Upload.vue
  │   │   ├── Config.vue
  │   │   └── Report.vue
  │   ├── components/
  │   ├── api/
  │   │   └── index.js
  │   └── stores/
  │       └── project.js
  ├── package.json
  └── vite.config.js
  ```

- [ ] 安装依赖
  - Vue 3
  - Vue Router
  - Pinia
  - Element Plus
  - Axios

- [ ] 配置基础路由
  - / → Home.vue
  - /upload → Upload.vue
  - /config → Config.vue
  - /report → Report.vue

- [ ] 实现基础布局
  - 导航栏
  - 页面容器

#### 集成

- [ ] 配置前后端联调
  - Vite proxy 配置
  - CORS 配置

- [ ] 创建启动脚本
  - main.py（根目录启动入口）

### 验收标准

1. 后端可启动，访问 `http://localhost:8000/api/health` 返回成功
2. 前端可启动，访问 `http://localhost:5173` 显示界面
3. 前端可调用后端 API
4. 代码通过 linter 检查

---

## P2 阶段：属性图专题 - 数据处理

### 目标
实现数据加载和统计计算功能。

### 任务清单

#### 核心数据处理模块

- [ ] `core/data/load_csv.py`: 加载 CSV 文件
  - 自动识别编码（GBK/UTF-8）
  - 返回 pandas DataFrame

- [ ] `core/data/load_excel.py`: 加载 Excel 文件
  - 支持 .xlsx/.xls
  - 返回 pandas DataFrame

- [ ] `core/data/calc_mean.py`: 计算均值
  - 按指定列分组计算
  - 返回统计结果

- [ ] `core/data/calc_distribution.py`: 计算分布
  - 统计各等级占比
  - 返回分布数据

- [ ] `core/data/calc_grading.py`: 分级统计
  - 根据分级标准划分等级
  - 支持自定义分级规则

- [ ] `core/data/filter_by_column.py`: 按列筛选

- [ ] `core/data/group_by_column.py`: 按列分组

#### API 实现

- [ ] `api/upload.py`: 文件上传接口
  - POST `/api/upload`
  - 保存文件、解析预览

- [ ] `api/config.py`: 配置管理接口
  - GET/POST `/api/config`
  - GET/POST `/api/config/grading`

#### 前端实现

- [ ] Upload.vue: 文件上传页面
  - 文件拖拽上传
  - 数据预览表格

- [ ] Config.vue: 配置页面
  - 项目信息配置
  - 分级标准编辑器

### 验收标准

1. 能成功上传并解析 CSV/Excel 文件
2. 能正确计算统计指标
3. 配置可保存和读取
4. 所有功能有单元测试

---

## P3 阶段：属性图专题 - 图表生成

### 目标
实现统计图表的自动生成。

### 任务清单

#### 图表模块

- [ ] `core/chart/setup_chinese.py`: 中文字体配置
  - 自动查找系统中文字体
  - 配置 matplotlib 默认字体

- [ ] `core/chart/make_pie_chart.py`: 饼图生成
  - 支持自定义颜色
  - 支持百分比显示
  - 输出为 PNG 文件

- [ ] `core/chart/make_bar_chart.py`: 柱状图生成
  - 支持水平/垂直
  - 支持数值标签

- [ ] `core/chart/make_stack_chart.py`: 堆叠图生成
  - 支持多系列
  - 支持图例

#### 专题模块

- [ ] `topics/attribute_map/config.py`: 专题配置
- [ ] `topics/attribute_map/process.py`: 数据处理逻辑
- [ ] `topics/attribute_map/generate.py`: 图表生成逻辑

### 验收标准

1. 能生成标准饼图、柱状图、堆叠图
2. 图表中文显示正常
3. 图表清晰、美观

---

## P4 阶段：属性图专题 - 报告生成

### 目标
实现 Word 报告的自动生成。

### 任务清单

#### Word 模块

- [ ] `core/word/render_template.py`: 模板渲染
  - 使用 python-docx-template
  - 支持变量替换
  - 支持循环渲染

- [ ] `core/word/insert_chart.py`: 插入图表
  - 将生成的图表插入文档
  - 保持图表尺寸和位置

#### 报告 API

- [ ] `api/report.py`: 报告生成接口
  - POST `/api/report/generate`
  - GET `/api/report/preview`
  - GET `/api/report/download`

#### 前端实现

- [ ] Report.vue: 报告页面
  - 专题选择
  - 生成进度
  - 报告下载

### 验收标准

1. 能根据模板生成 Word 文档
2. 文档包含正确的数据和图表
3. 格式与模板一致

---

## P5 阶段：打包测试

### 目标
将应用打包为独立可执行文件。

### 任务清单

- [ ] 前端构建优化
  - 生产环境构建
  - 资源压缩

- [ ] 后端打包配置
  - build.spec 配置
  - 静态文件嵌入

- [ ] PyInstaller 打包
  - 单文件打包
  - 测试各平台兼容性

- [ ] 启动流程优化
  - 自动打开浏览器
  - 托盘图标（可选）

### 验收标准

1. exe 文件可在无 Python 环境的 Windows 上运行
2. 所有功能正常
3. 启动时间 < 10 秒

---

## P6+ 阶段：其他专题迭代

### 目标
扩展其他专题类型。

### 待添加专题

- [ ] 类型图专题
- [ ] 土壤适宜性专题
- [ ] 耕地质量专题
- [ ] 其他专题...

### 每个专题需要

1. `topics/{topic_name}/config.py`
2. `topics/{topic_name}/process.py`
3. `topics/{topic_name}/generate.py`
4. 对应的 Word 模板
5. 单元测试

---

## 开发规范提醒

### 每次开发前

1. 理解需求和现有代码
2. 制定计划并确认
3. 遵循 CLAUDE.md 代码规范

### 每次提交前

```bash
# 后端检查
cd backend
ruff check .
ruff format .
mypy .
pytest

# 前端检查
cd frontend
npm run lint
npm run format:check
npm test
```

### 质量红线

- 绝不使用 any 类型
- 绝不跳过错误处理
- 绝不硬编码密钥
- 所有功能必须有测试
