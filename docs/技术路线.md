# 农业土壤普查报告生成系统 - 技术路线

## 一、系统概述

| 项目 | 说明 |
|------|------|
| 系统名称 | 农业土壤普查报告生成系统 |
| 目标用户 | 技术人员 |
| 运行方式 | 本地运行，打包为 exe |
| 核心功能 | 数据处理 → 图表生成 → Word报告输出 |

## 二、技术栈

| 层面 | 技术 | 版本 | 用途 |
|------|------|------|------|
| **后端框架** | FastAPI | 0.109+ | Web API 服务 |
| **数据处理** | pandas | 2.0+ | CSV/Excel 数据处理 |
| **图表生成** | matplotlib | 3.8+ | 统计图表 |
| **Word生成** | python-docx-template | 0.16+ | 模板渲染 |
| **前端框架** | Vue 3 | 3.4+ | 用户界面 |
| **UI组件** | Element Plus | 2.5+ | 界面组件 |
| **构建工具** | Vite | 5.0+ | 前端构建 |
| **打包工具** | PyInstaller | 6.0+ | 打包为 exe |
| **Python** | Python | 3.11+ | 运行环境 |

## 三、系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                        用户界面 (Vue 3)                      │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │
│  │ 项目配置 │  │ 数据上传 │  │ 专题选择 │  │ 报告下载 │        │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      API 层 (FastAPI)                        │
│  /api/upload    /api/config    /api/report    /api/download │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        核心层 (Core)                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  data/       │  │  chart/      │  │  word/       │      │
│  │  数据处理    │  │  图表生成    │  │  Word渲染    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       专题层 (Topics)                        │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │ 属性图   │ │ 类型图   │ │ 适宜性   │ │ 耕地质量 │  ...  │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
└─────────────────────────────────────────────────────────────┘
```

## 四、目录结构

```
soil-report/
├── backend/
│   ├── app/
│   │   ├── __init__.py
│   │   ├── main.py                      # FastAPI 入口
│   │   ├── config.py                    # 全局配置
│   │   │
│   │   ├── api/                         # API 路由
│   │   │   ├── __init__.py
│   │   │   ├── upload.py                # 文件上传
│   │   │   ├── config.py                # 配置管理
│   │   │   └── report.py                # 报告生成
│   │   │
│   │   ├── core/                        # 核心功能
│   │   │   ├── __init__.py
│   │   │   │
│   │   │   ├── data/                    # 数据处理
│   │   │   │   ├── __init__.py
│   │   │   │   ├── load_excel.py        # 加载Excel
│   │   │   │   ├── load_csv.py          # 加载CSV
│   │   │   │   ├── calc_mean.py         # 计算均值
│   │   │   │   ├── calc_distribution.py # 计算分布
│   │   │   │   ├── calc_grading.py      # 分级统计
│   │   │   │   ├── filter_by_column.py  # 按列筛选
│   │   │   │   └── group_by_column.py   # 按列分组
│   │   │   │
│   │   │   ├── chart/                   # 图表生成
│   │   │   │   ├── __init__.py
│   │   │   │   ├── setup_chinese.py     # 中文字体配置
│   │   │   │   ├── make_pie_chart.py    # 饼图
│   │   │   │   ├── make_bar_chart.py    # 柱状图
│   │   │   │   └── make_stack_chart.py  # 堆叠图
│   │   │   │
│   │   │   └── word/                    # Word 生成
│   │   │       ├── __init__.py
│   │   │       ├── render_template.py   # 模板渲染
│   │   │       └── insert_chart.py      # 插入图表
│   │   │
│   │   ├── topics/                      # 专题模块
│   │   │   ├── __init__.py
│   │   │   ├── base.py                  # 专题基类
│   │   │   │
│   │   │   └── attribute_map/           # 属性图专题
│   │   │       ├── __init__.py
│   │   │       ├── config.py            # 专题配置
│   │   │       ├── process.py           # 数据处理
│   │   │       └── generate.py          # 报告生成
│   │   │
│   │   └── models/                      # 数据模型
│   │       ├── __init__.py
│   │       └── schemas.py               # Pydantic 模型
│   │
│   ├── templates/                       # Word 模板
│   │   └── attribute_map.docx
│   │
│   ├── output/                          # 输出目录
│   ├── tests/                           # 测试
│   └── requirements.txt
│
├── frontend/
│   ├── src/
│   │   ├── App.vue
│   │   ├── main.js
│   │   ├── views/
│   │   │   ├── Home.vue                 # 首页
│   │   │   ├── Upload.vue               # 上传页
│   │   │   ├── Config.vue               # 配置页
│   │   │   └── Report.vue               # 报告页
│   │   ├── components/
│   │   │   ├── FileUploader.vue
│   │   │   ├── GradingEditor.vue
│   │   │   └── ReportPreview.vue
│   │   ├── api/
│   │   │   └── index.js                 # API 调用
│   │   └── stores/
│   │       └── project.js               # 状态管理
│   ├── package.json
│   └── vite.config.js
│
├── main.py                              # 启动入口
├── build.spec                           # PyInstaller 配置
└── README.md
```

## 五、数据流设计

```
用户上传文件
      │
      ▼
┌─────────────────┐
│  load_csv.py    │  ← 识别编码 (GBK/UTF-8)
│  load_excel.py  │
└────────┬────────┘
         │
         ▼ DataFrame
┌─────────────────────────────────────────┐
│              数据处理流水线              │
│  calc_mean → calc_distribution →        │
│  calc_grading → group_by_column         │
└────────┬────────────────────────────────┘
         │
         ▼ 统计结果 dict
┌─────────────────────────────────────────┐
│              图表生成                    │
│  make_pie_chart / make_bar_chart        │
└────────┬────────────────────────────────┘
         │
         ▼ 图表文件 Path
┌─────────────────────────────────────────┐
│              Word 渲染                   │
│  render_template + insert_chart         │
└────────┬────────────────────────────────┘
         │
         ▼
    生成 .docx 报告
```

## 六、API 设计

| 端点 | 方法 | 功能 |
|------|------|------|
| `/api/upload` | POST | 上传数据文件 |
| `/api/config` | GET/POST | 获取/保存项目配置 |
| `/api/config/grading` | GET/POST | 获取/保存分级标准 |
| `/api/topics` | GET | 获取可用专题列表 |
| `/api/report/generate` | POST | 生成报告 |
| `/api/report/preview` | GET | 预览报告 |
| `/api/report/download` | GET | 下载报告 |

## 七、配置结构

```json
{
  "project": {
    "region_name": "XX县",
    "survey_year": 2024,
    "historical_year": 2010
  },
  "grading_standards": {
    "ph": [
      {"level": 1, "name": "强酸性", "min": 0, "max": 4.5},
      {"level": 2, "name": "酸性", "min": 4.5, "max": 5.5},
      {"level": 3, "name": "微酸性", "min": 5.5, "max": 6.5},
      {"level": 4, "name": "中性", "min": 6.5, "max": 7.5},
      {"level": 5, "name": "微碱性", "min": 7.5, "max": 8.5},
      {"level": 6, "name": "碱性", "min": 8.5, "max": 14}
    ],
    "om": [],
    "tn": []
  }
}
```

## 八、打包方案

```
1. 前端构建
   npm run build → dist/

2. 静态文件嵌入
   FastAPI 挂载 dist/ 为静态资源

3. PyInstaller 打包
   pyinstaller build.spec → soil-report.exe

4. 启动流程
   exe → 启动 uvicorn → 打开浏览器 → localhost:8000
```

## 九、迭代计划

| 阶段 | 内容 | 产出 |
|------|------|------|
| **P1** | 项目骨架 + 基础框架 | 可运行的空壳 |
| **P2** | 属性图专题 - 数据处理 | 统计计算功能 |
| **P3** | 属性图专题 - 图表生成 | 图表输出 |
| **P4** | 属性图专题 - 报告生成 | 完整报告 |
| **P5** | 打包测试 | exe 文件 |
| **P6+** | 其他专题迭代 | 完整系统 |

## 十、代码规范

参考 `CLAUDE.md` 文件，遵循以下规范：

### 10.1 命名规范

- 文件命名：`snake_case.py`（如 `load_csv.py`）
- 函数命名：`snake_case`，动词开头（如 `load_data`、`calc_mean`）
- 类命名：`PascalCase`（如 `ReportGenerator`）
- 常量命名：`SCREAMING_SNAKE_CASE`（如 `MAX_FILE_SIZE`）

### 10.2 函数规范

- 每个函数单独一个文件
- 单个函数不超过 30 行
- 参数不超过 4 个
- 必须声明类型注解和返回类型

### 10.3 质量红线

- 绝不使用 `any` 类型
- 绝不使用 `@ts-ignore` 或 `eslint-disable`
- 绝不跳过错误处理
- 绝不硬编码密钥/凭证

### 10.4 提交前检查

```bash
# Linter 检查
npm run lint        # 前端
ruff check .        # 后端

# 类型检查
mypy .              # 后端

# 测试
pytest              # 后端
npm test            # 前端

# 格式化
ruff format .       # 后端
npm run format      # 前端
```
